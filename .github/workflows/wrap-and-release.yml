name: Wrap and Release
on:
  push:
    branches: [master]
jobs:
  wrap-and-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Lua
        run: |
          sudo apt-get update && sudo apt-get install -y lua5.3
          sudo ln -sf /usr/bin/lua5.3 /usr/local/bin/lua

      - name: Install Node.js dependencies
        run: cd scripts && npm install

      - name: Detect Version Number
        run: |
          VERSION_NUMBER=$( ./scripts/version-number-from-src.sh )
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_ENV

      - name: Build ArchHUD.conf
        run: ./scripts/wrap.sh true

      - name: Build ArchHUD.zip
        run: |
          mkdir -p build/archhud/custom
          cp ArchHUD.conf build/
          cp Arch-ECU.conf build/
          cp src/requires/*.lua build/archhud/
          cp src/requires/privatelocations.sample build/archhud/
          cp src/requires/blankhudclass.example build/archhud/
          cp src/requires/userclass.example build/archhud/
          cp src/requires/custom/userglobals.example build/archhud/custom/
          cd build && zip -r ../ArchHUD.zip .

      - name: Create Release Notes
        run: |
          cat ./scripts/ReleaseNotesTemplate.md > ReleaseNotes.md
          ./scripts/latest-changes.sh >> ReleaseNotes.md

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete existing release with same tag if present (idempotent rebuild)
          gh release delete "v${{ env.VERSION_NUMBER }}" --yes 2>/dev/null || true
          git push --delete origin "v${{ env.VERSION_NUMBER }}" 2>/dev/null || true
          gh release create "v${{ env.VERSION_NUMBER }}" \
            --title "Release v${{ env.VERSION_NUMBER }}" \
            --notes-file ReleaseNotes.md \
            ArchHUD.zip
