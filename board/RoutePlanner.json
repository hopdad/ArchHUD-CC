{
  "slots": {
    "0": {
      "name": "db",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "1": {
      "name": "screen",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "-1": {
      "name": "unit",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "-2": {
      "name": "system",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "-3": {
      "name": "library",
      "type": {
        "events": [],
        "methods": []
      }
    }
  },
  "handlers": [
    {
      "code": "-- ArchHUD Route Planner Display - Programming Board Script\n-- Reads route telemetry (T_route) and autopilot data (T_ap, T_flight) from a shared\n-- databank and renders a route overview on a linked screen.\n--\n-- ═══════════════════════════════════════════════════════\n-- SETUP INSTRUCTIONS\n-- ═══════════════════════════════════════════════════════\n-- 1. Place a programming board, a screen, and link BOTH to the same databank\n--    used by your ArchHUD seat (the dbHud slot).\n-- 2. Right-click the programming board > Advanced > Edit Lua.\n-- 3. In the slot list (left side), rename the databank slot to \"db\"\n--    and the screen slot to \"screen\".\n-- 4. Select the filter: unit > onStart\n--    Paste this ENTIRE script into the code editor.\n-- 5. Add a NEW filter: unit > onTimer(timerId)\n--    Paste this single line:     onBoardTick(timerId)\n-- 6. Add a NEW filter: unit > onStop\n--    Paste this single line:     if screen then screen.setHTML(\"\") end\n-- 7. Apply changes and activate the programming board.\n-- ═══════════════════════════════════════════════════════\n--\n-- Shows: active route waypoints with leg distances, ship distance, ETAs,\n-- overall progress bar, and saved route status.\n--\n-- Slots (rename in the Lua editor slot list):\n--   db     = databank (same one linked to your seat/ECU as dbHud)\n--   screen = ScreenUnit\n--\n-- Databank keys used:\n--   T_route  = {active, count, wps=[...], totalDist, remainDist, totalEta, remainEta, progress, tgt, spd}\n--   T_ap     = {on, stat, tgt, dist, bDist, bTime, ...}\n--   T_flight = {spd, alt, time, ...}\n\nlocal db = db         ---@type databank\nlocal screen = screen ---@type ScreenUnit\nlocal unit = unit     ---@type ProgrammingBoard\nlocal system = system\n\n-- json fallback for emulators (du-lua.dev) where the library slot\n-- doesn't inject the json global automatically.\nif not json then\n    json = {}\n    -- Minimal JSON decoder\n    function json.decode(s)\n        if not s or s == \"\" then return nil end\n        local i = 1\n        local V\n        local function w() while i <= #s and s:byte(i) <= 32 do i = i + 1 end end\n        local function S()\n            i = i + 1; local b = {}\n            while true do\n                local c = s:sub(i,i)\n                if c == '\"' then break\n                elseif c == '\\\\' then i=i+1; c=s:sub(i,i); if c=='n' then b[#b+1]='\\n' elseif c=='t' then b[#b+1]='\\t' else b[#b+1]=c end\n                else b[#b+1] = c end\n                i = i + 1\n            end\n            i = i + 1; return table.concat(b)\n        end\n        V = function()\n            w(); local c = s:sub(i,i)\n            if c == '\"' then return S()\n            elseif c == '{' then\n                i=i+1; w(); local t = {}\n                if s:sub(i,i) ~= '}' then\n                    local k = S(); w(); i=i+1; t[k] = V()\n                    while true do w(); if s:sub(i,i) ~= ',' then break end; i=i+1; k=S(); w(); i=i+1; t[k]=V() end\n                end; w(); i=i+1; return t\n            elseif c == '[' then\n                i=i+1; w(); local t = {}\n                if s:sub(i,i) ~= ']' then\n                    t[1]=V(); local n=1\n                    while true do w(); if s:sub(i,i) ~= ',' then break end; i=i+1; n=n+1; t[n]=V() end\n                end; w(); i=i+1; return t\n            elseif c == 't' then i=i+4; return true\n            elseif c == 'f' then i=i+5; return false\n            elseif c == 'n' then i=i+4; return nil\n            else local j2=i; if c=='-' then i=i+1 end; while i<=#s and s:sub(i,i):match('[%deE%.%+%-]') do i=i+1 end; return tonumber(s:sub(j2,i-1))\n            end\n        end\n        local ok, r = pcall(V); return ok and r or nil\n    end\n    -- Minimal JSON encoder\n    function json.encode(val)\n        local buf = {}\n        local function enc(v)\n            local tp = type(v)\n            if v == nil then buf[#buf+1] = \"null\"\n            elseif tp == \"boolean\" then buf[#buf+1] = v and \"true\" or \"false\"\n            elseif tp == \"number\" then\n                if v ~= v then buf[#buf+1] = \"null\"\n                elseif v == 1/0 then buf[#buf+1] = \"1e999\"\n                elseif v == -1/0 then buf[#buf+1] = \"-1e999\"\n                else buf[#buf+1] = string.format(\"%.14g\", v) end\n            elseif tp == \"string\" then\n                buf[#buf+1] = '\"'; buf[#buf+1] = v:gsub('[\\\\\"\\n\\t\\r]', {['\\\\']='\\\\\\\\',  ['\"']='\\\\\"', ['\\n']='\\\\n', ['\\t']='\\\\t', ['\\r']='\\\\r'}); buf[#buf+1] = '\"'\n            elseif tp == \"table\" then\n                -- Detect array vs object: sequential integer keys from 1..#v\n                local n = #v\n                local isArr = n > 0\n                if isArr then for k in pairs(v) do if type(k) ~= \"number\" or k < 1 or k > n or k ~= math.floor(k) then isArr = false; break end end end\n                if isArr then\n                    buf[#buf+1] = '['\n                    for i = 1, n do if i > 1 then buf[#buf+1] = ',' end; enc(v[i]) end\n                    buf[#buf+1] = ']'\n                else\n                    buf[#buf+1] = '{'\n                    local first = true\n                    for k2, v2 in pairs(v) do\n                        if type(k2) == \"string\" then\n                            if not first then buf[#buf+1] = ',' end; first = false\n                            enc(k2); buf[#buf+1] = ':'; enc(v2)\n                        end\n                    end\n                    buf[#buf+1] = '}'\n                end\n            end\n        end\n        enc(val)\n        return table.concat(buf)\n    end\nend\nlocal jdecode = json.decode\nlocal mfloor  = math.floor\nlocal mmin    = math.min\nlocal mmax    = math.max\nlocal stringf = string.format\n\n-- ═══════════════════════════════════════════════\n-- Utility Functions\n-- ═══════════════════════════════════════════════\n\nlocal function safeDecode(key)\n    if not db.hasKey(key) then return nil end\n    local ok, result = pcall(jdecode, db.getStringValue(key))\n    if ok then return result end\n    return nil\nend\n\nlocal function esc(str)\n    if not str then return \"?\" end\n    return str:gsub(\"&\", \"&amp;\"):gsub(\"<\", \"&lt;\"):gsub(\">\", \"&gt;\"):gsub('\"', \"&quot;\")\nend\n\nlocal function rgb(r, g, b)\n    return stringf(\"rgb(%d,%d,%d)\", r, g, b)\nend\n\nlocal function rgba(r, g, b, a)\n    return stringf(\"rgba(%d,%d,%d,%.2f)\", r, g, b, a)\nend\n\n-- ═══════════════════════════════════════════════\n-- Theme Colors\n-- ═══════════════════════════════════════════════\n\nlocal accentColor = rgb(130, 224, 255)\nlocal dimColor    = rgb(90, 155, 180)\nlocal warnColor   = rgb(255, 165, 0)\nlocal dangerColor = rgb(255, 60, 60)\nlocal safeColor   = rgb(60, 255, 120)\nlocal bgColor     = rgb(12, 16, 22)\nlocal panelColor  = rgba(20, 30, 40, 0.85)\nlocal borderColor = rgba(130, 224, 255, 0.3)\nlocal routeColor  = rgb(100, 200, 255)       -- Route line/connector color\nlocal completedColor = rgba(60, 255, 120, 0.6) -- Completed waypoint\nlocal currentColor = rgb(255, 220, 50)         -- Current target highlight\nlocal pendingColor = rgba(130, 224, 255, 0.5)  -- Future waypoints\n\n-- ═══════════════════════════════════════════════\n-- Formatting Helpers\n-- ═══════════════════════════════════════════════\n\n--- Format distance for display\nlocal function fmtDist(meters)\n    if not meters or meters == 0 then return \"---\" end\n    if meters > 200000 then\n        return stringf(\"%.2f su\", meters / 200000)\n    elseif meters > 10000 then\n        return stringf(\"%.1f km\", meters / 1000)\n    elseif meters > 1000 then\n        return stringf(\"%.2f km\", meters / 1000)\n    else\n        return stringf(\"%.0f m\", meters)\n    end\nend\n\n--- Format time in seconds to readable string\nlocal function fmtTime(seconds)\n    if not seconds or seconds <= 0 then return \"---\" end\n    if seconds > 86400 then\n        local d = mfloor(seconds / 86400)\n        local h = mfloor((seconds % 86400) / 3600)\n        return stringf(\"%dd %dh\", d, h)\n    elseif seconds > 3600 then\n        local h = mfloor(seconds / 3600)\n        local m = mfloor((seconds % 3600) / 60)\n        return stringf(\"%dh %dm\", h, m)\n    elseif seconds > 60 then\n        local m = mfloor(seconds / 60)\n        local s = mfloor(seconds % 60)\n        return stringf(\"%dm %ds\", m, s)\n    else\n        return stringf(\"%ds\", mfloor(seconds))\n    end\nend\n\n--- Format speed\nlocal function fmtSpeed(mps)\n    if not mps or mps == 0 then return \"0 km/h\" end\n    return stringf(\"%.0f km/h\", mps * 3.6)\nend\n\n-- ═══════════════════════════════════════════════\n-- Main Render Function\n-- ═══════════════════════════════════════════════\n\nfunction renderDashboard()\n    local route  = safeDecode(\"T_route\")\n    local ap     = safeDecode(\"T_ap\")\n    local flight = safeDecode(\"T_flight\")\n\n    local sw, sh = 1920, 1080\n    local svg = {}\n\n    svg[#svg+1] = stringf([[<svg viewBox=\"0 0 %d %d\" xmlns=\"http://www.w3.org/2000/svg\">]], sw, sh)\n\n    -- Background\n    svg[#svg+1] = stringf([[<rect width=\"%d\" height=\"%d\" fill=\"%s\"/>]], sw, sh, bgColor)\n\n    -- ── Title Bar ──────────────────────────────\n    svg[#svg+1] = stringf(\n        [[<rect x=\"0\" y=\"0\" width=\"%d\" height=\"50\" fill=\"%s\"/>]] ..\n        [[<text x=\"20\" y=\"34\" fill=\"%s\" font-size=\"22\" font-family=\"monospace\" font-weight=\"bold\">ARCHHUD ROUTE PLANNER</text>]],\n        sw, rgba(20, 30, 40, 0.95), accentColor)\n\n    -- Data freshness indicator (top right)\n    if flight and flight.time then\n        local age = system.getArkTime() - flight.time\n        local freshColor = age < 5 and safeColor or (age < 15 and warnColor or dangerColor)\n        local freshText = age < 5 and \"LIVE\" or stringf(\"%.0fs AGO\", age)\n        svg[#svg+1] = stringf(\n            [[<circle cx=\"%d\" cy=\"25\" r=\"5\" fill=\"%s\"/>]] ..\n            [[<text x=\"%d\" y=\"30\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" text-anchor=\"end\">DATA: %s</text>]],\n            sw - 200, freshColor, sw - 20, freshColor, freshText)\n    end\n\n    -- ── No Data Fallback ─────────────────────────\n    if not route then\n        svg[#svg+1] = stringf(\n            [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"28\" font-family=\"monospace\" text-anchor=\"middle\" font-weight=\"bold\">AWAITING DATA</text>]] ..\n            [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" text-anchor=\"middle\">Link this board to the same databank as your ArchHUD seat</text>]] ..\n            [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" text-anchor=\"middle\">Route telemetry is published every 3 seconds while seated</text>]],\n            sw/2, sh/2 - 30, warnColor,\n            sw/2, sh/2 + 10, dimColor,\n            sw/2, sh/2 + 40, dimColor)\n        svg[#svg+1] = \"</svg>\"\n        return table.concat(svg)\n    end\n\n    -- ══════════════════════════════════════════════\n    -- NO ACTIVE ROUTE\n    -- ══════════════════════════════════════════════\n    if not route.active then\n        -- Show \"no route\" state with saved route info\n        svg[#svg+1] = stringf(\n            [[<rect x=\"40\" y=\"80\" width=\"%d\" height=\"200\" fill=\"%s\" stroke=\"%s\" rx=\"8\"/>]],\n            sw - 80, panelColor, borderColor)\n\n        svg[#svg+1] = stringf(\n            [[<text x=\"%d\" y=\"170\" fill=\"%s\" font-size=\"32\" font-family=\"monospace\" text-anchor=\"middle\" font-weight=\"bold\">NO ACTIVE ROUTE</text>]],\n            sw/2, dimColor)\n\n        svg[#svg+1] = stringf(\n            [[<text x=\"%d\" y=\"210\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" text-anchor=\"middle\">Select a target in ArchHUD and use ALT+9 to add waypoints to a route</text>]],\n            sw/2, rgba(130, 224, 255, 0.5))\n\n        -- Saved route status\n        if route.saved and route.savedCount > 0 then\n            svg[#svg+1] = stringf(\n                [[<text x=\"%d\" y=\"250\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" text-anchor=\"middle\">Saved route available: %d waypoints (use ALT+9 menu to load)</text>]],\n                sw/2, safeColor, route.savedCount)\n\n            -- Show saved route waypoints if available\n            if route.savedList then\n                local listY = 320\n                svg[#svg+1] = stringf(\n                    [[<rect x=\"40\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" stroke=\"%s\" rx=\"8\"/>]],\n                    listY - 10, sw - 80, mmin(#route.savedList * 40 + 60, sh - listY - 30), panelColor, borderColor)\n\n                svg[#svg+1] = stringf(\n                    [[<text x=\"70\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">SAVED ROUTE</text>]],\n                    listY + 20, accentColor)\n\n                -- Separator\n                svg[#svg+1] = stringf(\n                    [[<line x1=\"60\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke=\"%s\" stroke-width=\"1\"/>]],\n                    listY + 30, sw - 60, listY + 30, borderColor)\n\n                local ey = listY + 55\n                local maxShow = mfloor((sh - listY - 80) / 40)\n                for i = 1, mmin(#route.savedList, maxShow) do\n                    local name = esc(route.savedList[i])\n\n                    -- Waypoint number circle\n                    svg[#svg+1] = stringf(\n                        [[<circle cx=\"85\" cy=\"%d\" r=\"12\" fill=\"none\" stroke=\"%s\" stroke-width=\"1.5\"/>]] ..\n                        [[<text x=\"85\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\" text-anchor=\"middle\">%d</text>]],\n                        ey - 5, pendingColor, ey - 1, pendingColor, i)\n\n                    -- Connector line to next waypoint\n                    if i < #route.savedList and i < maxShow then\n                        svg[#svg+1] = stringf(\n                            [[<line x1=\"85\" y1=\"%d\" x2=\"85\" y2=\"%d\" stroke=\"%s\" stroke-width=\"1\" stroke-dasharray=\"4,3\"/>]],\n                            ey + 7, ey + 28, rgba(130, 224, 255, 0.2))\n                    end\n\n                    -- Name\n                    svg[#svg+1] = stringf(\n                        [[<text x=\"115\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\">%s</text>]],\n                        ey, pendingColor, name)\n\n                    ey = ey + 40\n                end\n\n                if #route.savedList > maxShow then\n                    svg[#svg+1] = stringf(\n                        [[<text x=\"115\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\">... +%d more waypoints</text>]],\n                        ey, dimColor, #route.savedList - maxShow)\n                end\n            end\n        else\n            svg[#svg+1] = stringf(\n                [[<text x=\"%d\" y=\"250\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\" text-anchor=\"middle\">No saved route on databank</text>]],\n                sw/2, dimColor)\n        end\n\n        -- Autopilot status footer\n        if ap then\n            svg[#svg+1] = stringf(\n                [[<text x=\"40\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">AP TARGET: %s</text>]],\n                sh - 20, ap.on and safeColor or dimColor, esc(ap.tgt or \"None\"))\n            if ap.dist and ap.dist > 0 then\n                svg[#svg+1] = stringf(\n                    [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" text-anchor=\"end\">DISTANCE: %s</text>]],\n                    sw - 40, sh - 20, dimColor, fmtDist(ap.dist))\n            end\n        end\n\n        svg[#svg+1] = \"</svg>\"\n        return table.concat(svg)\n    end\n\n    -- ══════════════════════════════════════════════\n    -- ACTIVE ROUTE DISPLAY\n    -- ══════════════════════════════════════════════\n\n    local wps = route.wps or {}\n    local wpCount = route.count or #wps\n    local progress = route.progress or 0\n    local spd = route.spd or 0\n\n    -- ── Overview Panel ────────────────────────────\n    local ovY = 60\n    local ovH = 130\n    svg[#svg+1] = stringf(\n        [[<rect x=\"20\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" stroke=\"%s\" rx=\"6\"/>]],\n        ovY, sw - 40, ovH, panelColor, borderColor)\n\n    -- Route progress label\n    svg[#svg+1] = stringf(\n        [[<text x=\"50\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">ROUTE PROGRESS</text>]],\n        ovY + 28, dimColor)\n\n    -- Progress percentage (large)\n    svg[#svg+1] = stringf(\n        [[<text x=\"260\" y=\"%d\" fill=\"%s\" font-size=\"28\" font-family=\"monospace\" font-weight=\"bold\">%.1f%%</text>]],\n        ovY + 30, accentColor, progress)\n\n    -- Progress bar\n    local pBarX = 50\n    local pBarY = ovY + 42\n    local pBarW = sw - 100\n    local pBarH = 20\n    local pBarFill = mmax(0, mfloor(pBarW * progress / 100))\n\n    -- Bar track\n    svg[#svg+1] = stringf(\n        [[<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" rx=\"4\"/>]],\n        pBarX, pBarY, pBarW, pBarH, rgba(40, 50, 60, 0.8))\n\n    -- Bar fill\n    if pBarFill > 0 then\n        svg[#svg+1] = stringf(\n            [[<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" rx=\"4\"/>]],\n            pBarX, pBarY, pBarFill, pBarH, accentColor)\n    end\n\n    -- Bar border\n    svg[#svg+1] = stringf(\n        [[<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"none\" stroke=\"%s\" rx=\"4\"/>]],\n        pBarX, pBarY, pBarW, pBarH, borderColor)\n\n    -- Waypoint markers on progress bar\n    for i = 1, wpCount do\n        local markerX = pBarX + mfloor(pBarW * (i / wpCount))\n        local markerColor = wps[i] and wps[i].cur and currentColor or rgba(255, 255, 255, 0.4)\n        svg[#svg+1] = stringf(\n            [[<line x1=\"%d\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke=\"%s\" stroke-width=\"1\"/>]],\n            markerX, pBarY, markerX, pBarY + pBarH, markerColor)\n    end\n\n    -- Stats row below progress bar\n    local statsY = pBarY + pBarH + 22\n\n    -- Total distance\n    svg[#svg+1] = stringf(\n        [[<text x=\"50\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\">TOTAL</text>]] ..\n        [[<text x=\"50\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">%s</text>]],\n        statsY, dimColor, statsY + 18, accentColor, fmtDist(route.totalDist))\n\n    -- Remaining distance\n    svg[#svg+1] = stringf(\n        [[<text x=\"350\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\">REMAINING</text>]] ..\n        [[<text x=\"350\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">%s</text>]],\n        statsY, dimColor, statsY + 18, warnColor, fmtDist(route.remainDist))\n\n    -- ETA to completion\n    svg[#svg+1] = stringf(\n        [[<text x=\"700\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\">ETA</text>]] ..\n        [[<text x=\"700\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">%s</text>]],\n        statsY, dimColor, statsY + 18, safeColor, fmtTime(route.remainEta))\n\n    -- Current speed\n    svg[#svg+1] = stringf(\n        [[<text x=\"1000\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\">SPEED</text>]] ..\n        [[<text x=\"1000\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">%s</text>]],\n        statsY, dimColor, statsY + 18, accentColor, fmtSpeed(spd))\n\n    -- Waypoints counter\n    svg[#svg+1] = stringf(\n        [[<text x=\"1350\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\">WAYPOINTS</text>]] ..\n        [[<text x=\"1350\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">%d</text>]],\n        statsY, dimColor, statsY + 18, accentColor, wpCount)\n\n    -- Autopilot status\n    local apOn = ap and ap.on\n    local apStatColor = apOn and safeColor or dimColor\n    local apStatText = apOn and \"ACTIVE\" or \"OFF\"\n    svg[#svg+1] = stringf(\n        [[<text x=\"1600\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\">AUTOPILOT</text>]] ..\n        [[<text x=\"1600\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">%s</text>]],\n        statsY, dimColor, statsY + 18, apStatColor, apStatText)\n\n    -- ── Waypoint List Panel ──────────────────────\n    local listTop = ovY + ovH + 15\n    local listBot = sh - 50\n    local listX = 20\n    local listW = sw - 40\n\n    svg[#svg+1] = stringf(\n        [[<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" stroke=\"%s\" rx=\"6\"/>]],\n        listX, listTop, listW, listBot - listTop, panelColor, borderColor)\n\n    -- Column headers\n    local hdrY = listTop + 25\n    local colNum = 70\n    local colName = 140\n    local colPlanet = 850\n    local colLeg = 1100\n    local colDist = 1350\n    local colEta = 1650\n\n    svg[#svg+1] = stringf(\n        [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" font-weight=\"bold\">#</text>]] ..\n        [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" font-weight=\"bold\">WAYPOINT</text>]] ..\n        [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" font-weight=\"bold\">PLANET</text>]] ..\n        [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" font-weight=\"bold\">LEG DIST</text>]] ..\n        [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" font-weight=\"bold\">FROM SHIP</text>]] ..\n        [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" font-weight=\"bold\">ETA</text>]],\n        colNum, hdrY, accentColor,\n        colName, hdrY, accentColor,\n        colPlanet, hdrY, accentColor,\n        colLeg, hdrY, accentColor,\n        colDist, hdrY, accentColor,\n        colEta, hdrY, accentColor)\n\n    -- Header separator\n    svg[#svg+1] = stringf(\n        [[<line x1=\"%d\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke=\"%s\" stroke-width=\"1\"/>]],\n        listX + 15, hdrY + 10, listX + listW - 15, hdrY + 10, borderColor)\n\n    -- ── Render Waypoint Rows ─────────────────────\n    local rowH = 58\n    local rowStartY = hdrY + 20\n    local maxRows = mfloor((listBot - rowStartY - 10) / rowH)\n    local connectorX = 55 -- X position for the vertical route line\n\n    for i = 1, mmin(wpCount, maxRows) do\n        local wp = wps[i]\n        if not wp then break end\n\n        local ry = rowStartY + ((i - 1) * rowH)\n        local isCurrent = wp.cur\n        local name = esc(wp.n or \"Unknown\")\n        if #name > 42 then name = name:sub(1, 40) .. \"..\" end\n        local planet = esc(wp.p or \"\")\n        local legDist = fmtDist(wp.leg)\n        local shipDist = fmtDist(wp.d)\n        local eta = \"---\"\n        if spd > 1 and wp.d and wp.d > 0 then\n            eta = fmtTime(wp.d / spd)\n        end\n\n        -- Row styling\n        local nodeColor, nameColor, textColor\n        if isCurrent then\n            nodeColor = currentColor\n            nameColor = currentColor\n            textColor = \"white\"\n            -- Highlight current row background\n            svg[#svg+1] = stringf(\n                [[<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" rx=\"3\"/>]],\n                listX + 5, ry - 8, listW - 10, rowH - 4, rgba(255, 220, 50, 0.08))\n        else\n            nodeColor = pendingColor\n            nameColor = pendingColor\n            textColor = dimColor\n        end\n\n        -- Vertical connector line (between waypoints)\n        if i < wpCount and i < maxRows then\n            svg[#svg+1] = stringf(\n                [[<line x1=\"%d\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke=\"%s\" stroke-width=\"2\" stroke-dasharray=\"4,4\"/>]],\n                connectorX, ry + 14, connectorX, ry + rowH - 8, rgba(130, 224, 255, 0.2))\n        end\n\n        -- Waypoint node circle\n        if isCurrent then\n            -- Double ring for current target\n            svg[#svg+1] = stringf(\n                [[<circle cx=\"%d\" cy=\"%d\" r=\"14\" fill=\"none\" stroke=\"%s\" stroke-width=\"2\"/>]] ..\n                [[<circle cx=\"%d\" cy=\"%d\" r=\"8\" fill=\"%s\"/>]],\n                connectorX, ry + 2, currentColor,\n                connectorX, ry + 2, currentColor)\n        else\n            svg[#svg+1] = stringf(\n                [[<circle cx=\"%d\" cy=\"%d\" r=\"12\" fill=\"none\" stroke=\"%s\" stroke-width=\"1.5\"/>]] ..\n                [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\" text-anchor=\"middle\">%d</text>]],\n                connectorX, ry + 2, nodeColor,\n                connectorX, ry + 6, nodeColor, i)\n        end\n\n        -- Waypoint number (for current, show as label instead)\n        if isCurrent then\n            svg[#svg+1] = stringf(\n                [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"11\" font-family=\"monospace\" text-anchor=\"middle\">%d</text>]],\n                connectorX, ry + 5, rgb(12, 16, 22), i)\n        end\n\n        -- Waypoint name\n        svg[#svg+1] = stringf(\n            [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"17\" font-family=\"monospace\"%s>%s</text>]],\n            colName, ry + 6, nameColor, isCurrent and ' font-weight=\"bold\"' or \"\", name)\n\n        -- Current target indicator label\n        if isCurrent then\n            svg[#svg+1] = stringf(\n                [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"11\" font-family=\"monospace\">CURRENT TARGET</text>]],\n                colName, ry + 22, currentColor)\n        end\n\n        -- Planet\n        svg[#svg+1] = stringf(\n            [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\">%s</text>]],\n            colPlanet, ry + 6, textColor, planet)\n\n        -- Leg distance\n        svg[#svg+1] = stringf(\n            [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\">%s</text>]],\n            colLeg, ry + 6, textColor, legDist)\n\n        -- Distance from ship\n        svg[#svg+1] = stringf(\n            [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\"%s>%s</text>]],\n            colDist, ry + 6, isCurrent and currentColor or textColor,\n            isCurrent and ' font-weight=\"bold\"' or \"\", shipDist)\n\n        -- ETA from ship\n        svg[#svg+1] = stringf(\n            [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\">%s</text>]],\n            colEta, ry + 6, isCurrent and safeColor or textColor, eta)\n    end\n\n    -- Overflow indicator\n    if wpCount > maxRows then\n        svg[#svg+1] = stringf(\n            [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" text-anchor=\"middle\">... +%d more waypoints</text>]],\n            sw/2, listBot - 10, dimColor, wpCount - maxRows)\n    end\n\n    -- ── Footer Bar ───────────────────────────────\n    local footY = sh - 35\n    svg[#svg+1] = stringf(\n        [[<line x1=\"20\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke=\"%s\" stroke-width=\"1\"/>]],\n        footY, sw - 20, footY, borderColor)\n\n    -- Current AP target\n    local tgtName = route.tgt or (ap and ap.tgt) or \"None\"\n    svg[#svg+1] = stringf(\n        [[<text x=\"40\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\">TARGET: %s</text>]],\n        footY + 18, accentColor, esc(tgtName))\n\n    -- Saved route indicator\n    if route.saved then\n        svg[#svg+1] = stringf(\n            [[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\" text-anchor=\"end\">SAVED ROUTE: %d WP</text>]],\n            sw - 40, footY + 18, dimColor, route.savedCount or 0)\n    end\n\n    svg[#svg+1] = \"</svg>\"\n    return table.concat(svg)\nend\n\n-- ═══════════════════════════════════════════════\n-- Timer callback (global so unit > onTimer can call it)\n-- In unit > onTimer, paste:  onBoardTick(timerId)\n-- ═══════════════════════════════════════════════\nfunction onBoardTick(timerId)\n    if timerId == \"refresh\" then\n        if screen and db then\n            screen.setHTML(renderDashboard())\n        end\n    end\nend\n\n-- ═══════════════════════════════════════════════\n-- Auto-initialization (runs on unit > onStart)\n-- ═══════════════════════════════════════════════\nif not db then\n    system.print(\"ArchHUD Route: No databank linked. Rename the databank slot to 'db' and restart.\")\n    return\nend\nif not screen then\n    system.print(\"ArchHUD Route: No screen linked. Rename the screen slot to 'screen' and restart.\")\n    return\nend\nunit.setTimer(\"refresh\", 3)\nsystem.print(\"ArchHUD Route Planner started.\")\nscreen.setHTML(renderDashboard())\n",
      "filter": {
        "args": [],
        "signature": "onStart()",
        "slotKey": "-1"
      },
      "key": "0"
    },
    {
      "code": "onBoardTick(timerId)",
      "filter": {
        "args": [
          {
            "value": "refresh"
          }
        ],
        "signature": "onTimer(timerId)",
        "slotKey": "-1"
      },
      "key": "1"
    },
    {
      "code": "if screen then screen.setHTML(\"\") end",
      "filter": {
        "args": [],
        "signature": "onStop()",
        "slotKey": "-1"
      },
      "key": "2"
    }
  ],
  "methods": [],
  "events": []
}