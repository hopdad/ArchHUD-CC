{
  "slots": {
    "0": {
      "name": "db",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "1": {
      "name": "screen",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "2": {
      "name": "screen2",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "-1": {
      "name": "unit",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "-2": {
      "name": "system",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "-3": {
      "name": "library",
      "type": {
        "events": [],
        "methods": []
      }
    }
  },
  "handlers": [
    {
      "code": "-- ArchHUD Combined Display - Programming Board Script\n-- All-in-one display: Telemetry, Radar, Damage, Flight Recorder, Route Planner.\n-- Click left/right side of screen to navigate between pages.\n-- Supports 1 or 2 screens, each independently navigable.\n--\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- SETUP INSTRUCTIONS\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- 1. Place a programming board, 1-2 screens, and link ALL to the same\n--    databank used by your ArchHUD seat (the dbHud slot).\n-- 2. Right-click the programming board > Advanced > Edit Lua.\n-- 3. Rename slots: databank=\"db\", first screen=\"screen\", second screen=\"screen2\"\n-- 4. Filter: unit > onStart           \u2192 paste this ENTIRE script\n-- 5. Filter: unit > onTimer(timerId)  \u2192 onBoardTick(timerId)\n-- 6. Filter: unit > onStop            \u2192 onBoardStop()\n-- 7. Filter: screen > onMouseDown(x,y) \u2192 onScreenNav(1,x)\n-- 8. (If 2 screens) Filter: screen2 > onMouseDown(x,y) \u2192 onScreenNav(2,x)\n-- 9. Apply and activate.\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\nlocal db = db           ---@type databank\nlocal screen = screen   ---@type ScreenUnit\nlocal screen2 = screen2 ---@type ScreenUnit\nlocal unit = unit       ---@type ProgrammingBoard\nlocal system = system\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- Configuration\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlocal TICK_INTERVAL = 2\nlocal RECORDER_TICKS = 5        -- Record snapshot every 5 ticks (10s)\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- Standard Library Cache\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlocal jdecode = json.decode\nlocal jencode = json.encode\nlocal mfloor = math.floor\nlocal mceil = math.ceil\nlocal mmin = math.min\nlocal mmax = math.max\nlocal stringf = string.format\nlocal tblSort = table.sort\nlocal tblConcat = table.concat\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- State\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlocal pageCount = 5\nlocal screen1Page = 1\nlocal screen2Page = 2\nlocal recorderTicks = 0\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- Shared Utilities\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlocal function safeDecode(key)\n    if not db.hasKey(key) then return nil end\n    local ok, r = pcall(jdecode, db.getStringValue(key))\n    if ok then return r end\n    return nil\nend\n\nlocal function esc(s)\n    if not s then return \"?\" end\n    return s:gsub(\"&\",\"&amp;\"):gsub(\"<\",\"&lt;\"):gsub(\">\",\"&gt;\"):gsub('\"',\"&quot;\")\nend\n\nlocal function rgb(r,g,b) return stringf(\"rgb(%d,%d,%d)\",r,g,b) end\nlocal function rgba(r,g,b,a) return stringf(\"rgba(%d,%d,%d,%.2f)\",r,g,b,a) end\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- Theme\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlocal accentColor = rgb(130,224,255)\nlocal dimColor    = rgb(90,155,180)\nlocal warnColor   = rgb(255,165,0)\nlocal dangerColor = rgb(255,60,60)\nlocal safeColor   = rgb(60,255,120)\nlocal pvpColor    = rgb(255,60,60)\nlocal bgColor     = rgb(12,16,22)\nlocal panelColor  = rgba(20,30,40,0.85)\nlocal borderColor = rgba(130,224,255,0.3)\nlocal gridColor   = rgba(130,224,255,0.12)\nlocal staticColor = rgb(100,110,125)\nlocal amberColor  = rgb(255,190,50)\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- Shared Formatting\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlocal function fmtDist(m)\n    if not m or m == 0 then return \"---\" end\n    if m > 200000 then return stringf(\"%.2f su\",m/200000)\n    elseif m > 10000 then return stringf(\"%.1f km\",m/1000)\n    elseif m > 1000 then return stringf(\"%.2f km\",m/1000)\n    else return stringf(\"%.0f m\",m) end\nend\nlocal function fmtTime(s)\n    if not s or s <= 0 then return \"---\" end\n    local d=mfloor(s/86400) local h=mfloor((s%86400)/3600) local m=mfloor((s%3600)/60) local sec=mfloor(s%60)\n    if d>365 then return \">1y\" elseif d>0 then return stringf(\"%dd %dh\",d,h)\n    elseif h>0 then return stringf(\"%dh %dm\",h,m) elseif m>0 then return stringf(\"%dm %ds\",m,sec)\n    else return stringf(\"%ds\",sec) end\nend\nlocal function fmtSpeed(mps) return stringf(\"%.0f km/h\",(mps or 0)*3.6) end\nlocal function fmtSpeedKmh(mps) return stringf(\"%.0f km/h\",(mps or 0)*3.6) end\nlocal function fmtSpeedMs(mps)\n    if (mps or 0)>1000 then return stringf(\"%.1f km/s\",mps/1000) else return stringf(\"%.0f m/s\",mps or 0) end\nend\nlocal function fmtAlt(m)\n    if (m or 0)>100000 then return stringf(\"%.2f su\",m/200000) elseif m>1000 then return stringf(\"%.1f km\",m/1000)\n    else return stringf(\"%.0f m\",m or 0) end\nend\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- Shared SVG Builders\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlocal SW, SH = 1920, 1080\nlocal pageNames = {\"TELEMETRY\",\"RADAR\",\"DAMAGE\",\"FLIGHT RECORDER\",\"ROUTE PLANNER\"}\n\nlocal function svgOpen(svg)\n    svg[#svg+1] = stringf('<svg viewBox=\"0 0 %d %d\" xmlns=\"http://www.w3.org/2000/svg\">',SW,SH)\n    svg[#svg+1] = stringf('<rect width=\"%d\" height=\"%d\" fill=\"%s\"/>',SW,SH,bgColor)\nend\n\nlocal function svgTitle(svg, title, rightText, rightClr)\n    svg[#svg+1] = stringf('<rect x=\"0\" y=\"0\" width=\"%d\" height=\"50\" fill=\"%s\"/>',SW,rgba(20,30,40,0.95))\n    svg[#svg+1] = stringf('<text x=\"20\" y=\"34\" fill=\"%s\" font-size=\"22\" font-family=\"monospace\" font-weight=\"bold\">%s</text>',accentColor,title)\n    if rightText then\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"34\" fill=\"%s\" font-size=\"18\" font-family=\"monospace\" text-anchor=\"end\">%s</text>',SW-20,rightClr or dimColor,rightText)\n    end\nend\n\nlocal function svgFresh(svg, flight, cx, cy)\n    if flight and flight.time then\n        local age = system.getArkTime() - flight.time\n        local fc = age<5 and safeColor or (age<15 and warnColor or dangerColor)\n        local ft = age<5 and \"LIVE\" or stringf(\"%.0fs AGO\",age)\n        svg[#svg+1] = stringf('<circle cx=\"%d\" cy=\"%d\" r=\"5\" fill=\"%s\"/>',cx,cy,fc)\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\">DATA: %s</text>',cx+12,cy+4,fc,ft)\n    end\nend\n\nlocal function svgPageNav(svg, pageIdx)\n    local ny = SH - 14\n    -- Left arrow\n    svg[#svg+1] = stringf('<text x=\"30\" y=\"%d\" fill=\"%s\" font-size=\"18\" font-family=\"monospace\" opacity=\"0.4\">\u25c4</text>',ny,accentColor)\n    -- Page name\n    svg[#svg+1] = stringf('<text x=\"960\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\" text-anchor=\"middle\">%s  %d/%d</text>',ny,dimColor,pageNames[pageIdx] or \"?\",pageIdx,pageCount)\n    -- Right arrow\n    svg[#svg+1] = stringf('<text x=\"1890\" y=\"%d\" fill=\"%s\" font-size=\"18\" font-family=\"monospace\" text-anchor=\"end\" opacity=\"0.4\">\u25ba</text>',ny,accentColor)\n    -- Page dots\n    local dotX = 960 - (pageCount*8)\n    for i=1,pageCount do\n        local dc = (i==pageIdx) and accentColor or rgba(60,70,80,0.6)\n        svg[#svg+1] = stringf('<circle cx=\"%d\" cy=\"%d\" r=\"3\" fill=\"%s\"/>',dotX+i*16,ny+10,dc)\n    end\nend\n\nlocal function svgClose(svg, pageIdx)\n    svgPageNav(svg, pageIdx)\n    svg[#svg+1] = '</svg>'\n    return tblConcat(svg)\nend\n\nlocal function svgNoData(svg, msg, pageIdx)\n    svg[#svg+1] = stringf('<text x=\"960\" y=\"500\" fill=\"%s\" font-size=\"28\" font-family=\"monospace\" text-anchor=\"middle\">AWAITING DATA</text>',warnColor)\n    svg[#svg+1] = stringf('<text x=\"960\" y=\"540\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" text-anchor=\"middle\">%s</text>',dimColor,msg)\n    return svgClose(svg, pageIdx)\nend\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- PAGE 1: TELEMETRY\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlocal function fuelBar(x,y,w,h,pct,label)\n    if not pct then return \"\" end\n    local fill = mfloor(w*pct/100)\n    local bc = accentColor\n    if pct<10 then bc=dangerColor elseif pct<25 then bc=warnColor end\n    return stringf(\n        '<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">%s</text>'..\n        '<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" rx=\"3\"/>'..\n        '<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" rx=\"3\"/>'..\n        '<text x=\"%d\" y=\"%d\" fill=\"white\" font-size=\"12\" font-family=\"monospace\" text-anchor=\"end\">%d%%</text>',\n        x,y-4,dimColor,label, x,y,w,h,rgba(40,50,60,0.8), x,y,fill,h,bc, x+w+40,y+h-3,pct)\nend\n\nlocal function statusDot(x,y,active,label)\n    local c = active and safeColor or rgba(60,70,80,0.8)\n    return stringf('<circle cx=\"%d\" cy=\"%d\" r=\"5\" fill=\"%s\"/><text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\">%s</text>',\n        x,y,c, x+12,y+4, active and accentColor or dimColor, label)\nend\n\nlocal function renderTelemetry(pageIdx)\n    local flight = safeDecode(\"T_flight\")\n    local ap = safeDecode(\"T_ap\")\n    local ship = safeDecode(\"T_ship\")\n    local fuel = safeDecode(\"T_fuel\")\n    local svg = {}\n    svgOpen(svg)\n    local isPvp = ship and ship.pvp\n    local zl = isPvp and \"PVP ZONE\" or \"SAFE ZONE\"\n    local zc = isPvp and pvpColor or safeColor\n    svgTitle(svg,\"ARCHHUD TELEMETRY\",zl,zc)\n    if ship and ship.ver then\n        svg[#svg+1] = stringf('<text x=\"380\" y=\"34\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">v%s</text>',dimColor,ship.ver)\n    end\n    if not flight then return svgNoData(svg,\"Link databank to same databank as ArchHUD seat\",pageIdx) end\n\n    local lx,ly = 30,70\n    svg[#svg+1] = stringf('<rect x=\"%d\" y=\"%d\" width=\"580\" height=\"320\" fill=\"%s\" stroke=\"%s\" rx=\"6\"/>',lx-10,ly,panelColor,borderColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">FLIGHT DATA</text>',lx+10,ly+28,accentColor)\n    local fy,lH = ly+55, 38\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">SPEED</text>',lx+10,fy,dimColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"white\" font-size=\"28\" font-family=\"monospace\">%s</text>',lx+120,fy+2,fmtSpeedKmh(flight.spd))\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">(%s)</text>',lx+380,fy,dimColor,fmtSpeedMs(flight.spd))\n    fy=fy+lH+6\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">ALTITUDE</text>',lx+10,fy,dimColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"white\" font-size=\"28\" font-family=\"monospace\">%s</text>',lx+120,fy+2,fmtAlt(flight.alt))\n    fy=fy+lH+6\n    local vColor = \"white\"\n    if flight.vspd>10 then vColor=safeColor elseif flight.vspd<-10 then vColor=warnColor end\n    local vSign = flight.vspd>=0 and \"+\" or \"\"\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">V-SPEED</text>',lx+10,fy,dimColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"28\" font-family=\"monospace\">%s%.1f m/s</text>',lx+120,fy+2,vColor,vSign,flight.vspd)\n    fy=fy+lH+6\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">ATMO</text>',lx+10,fy,dimColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"white\" font-size=\"22\" font-family=\"monospace\">%.1f%%</text>',lx+120,fy+2,flight.atmo)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">THROTTLE</text>',lx+280,fy,dimColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"white\" font-size=\"22\" font-family=\"monospace\">%d%%</text>',lx+400,fy+2,flight.thr)\n    fy=fy+lH\n    svg[#svg+1] = statusDot(lx+10,fy+8,flight.inA,\"IN ATMO\")\n    svg[#svg+1] = statusDot(lx+140,fy+8,flight.gear,\"GEAR\")\n    svg[#svg+1] = statusDot(lx+240,fy+8,flight.brk,\"BRAKE\")\n    svg[#svg+1] = statusDot(lx+350,fy+8,flight.near,\"NEAR PLANET\")\n\n    -- Autopilot panel\n    local rx = 640\n    svg[#svg+1] = stringf('<rect x=\"%d\" y=\"%d\" width=\"580\" height=\"320\" fill=\"%s\" stroke=\"%s\" rx=\"6\"/>',rx-10,ly,panelColor,borderColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">AUTOPILOT</text>',rx+10,ly+28,accentColor)\n    if ap then\n        local ay = ly+60\n        local asc = ap.on and safeColor or dimColor\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">STATUS</text>',rx+10,ay,dimColor)\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"24\" font-family=\"monospace\" font-weight=\"bold\">%s</text>',rx+120,ay+2,asc,ap.on and \"ENGAGED\" or \"OFF\")\n        ay=ay+lH\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">PHASE</text>',rx+10,ay,dimColor)\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"white\" font-size=\"20\" font-family=\"monospace\">%s</text>',rx+120,ay+2,ap.stat or \"---\")\n        ay=ay+lH\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">TARGET</text>',rx+10,ay,dimColor)\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"white\" font-size=\"20\" font-family=\"monospace\">%s</text>',rx+120,ay+2,ap.tgt or \"None\")\n        ay=ay+lH\n        if ap.dist and ap.dist>0 then\n            svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">DISTANCE</text>',rx+10,ay,dimColor)\n            svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"white\" font-size=\"20\" font-family=\"monospace\">%s</text>',rx+120,ay+2,fmtDist(ap.dist))\n        end\n        ay=ay+lH\n        if ap.bDist and ap.bDist>0 then\n            svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">BRAKE DIST</text>',rx+10,ay,dimColor)\n            svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"20\" font-family=\"monospace\">%s</text>',rx+120,ay+2,warnColor,fmtDist(ap.bDist))\n        end\n        ay=ay+lH+10\n        svg[#svg+1] = statusDot(rx+10,ay,ap.ah,\"ALT HOLD\")\n        svg[#svg+1] = statusDot(rx+150,ay,ap.tb,\"TURN+BURN\")\n        svg[#svg+1] = statusDot(rx+300,ay,ap.orb,\"ORBIT\")\n        svg[#svg+1] = statusDot(rx+420,ay,ap.re,\"REENTRY\")\n    end\n\n    -- Fuel panel\n    local by = 420\n    svg[#svg+1] = stringf('<rect x=\"%d\" y=\"%d\" width=\"580\" height=\"220\" fill=\"%s\" stroke=\"%s\" rx=\"6\"/>',lx-10,by,panelColor,borderColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">FUEL</text>',lx+10,by+28,accentColor)\n    if fuel then\n        local barY,barW,barH,barS = by+50, 420, 18, 55\n        if fuel.atmo then svg[#svg+1] = fuelBar(lx+10,barY,barW,barH,fuel.atmo.pct,stringf(\"ATMO  [%d]\",fuel.atmo.count)); barY=barY+barS end\n        if fuel.space then svg[#svg+1] = fuelBar(lx+10,barY,barW,barH,fuel.space.pct,stringf(\"SPACE [%d]\",fuel.space.count)); barY=barY+barS end\n        if fuel.rocket then svg[#svg+1] = fuelBar(lx+10,barY,barW,barH,fuel.rocket.pct,stringf(\"RCKT  [%d]\",fuel.rocket.count)) end\n    else\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">No fuel data</text>',lx+10,by+60,dimColor)\n    end\n\n    -- Ship status panel\n    svg[#svg+1] = stringf('<rect x=\"%d\" y=\"%d\" width=\"580\" height=\"220\" fill=\"%s\" stroke=\"%s\" rx=\"6\"/>',rx-10,by,panelColor,borderColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">SHIP STATUS</text>',rx+10,by+28,accentColor)\n    local sy = by+60\n    if ship and ship.shld >= 0 then\n        local sc = accentColor\n        if ship.shld<25 then sc=dangerColor elseif ship.shld<50 then sc=warnColor end\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">SHIELD</text>',rx+10,sy,dimColor)\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"24\" font-family=\"monospace\">%d%%</text>',rx+120,sy+2,sc,ship.shld)\n    else\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">SHIELD</text><text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"20\" font-family=\"monospace\">N/A</text>',rx+10,sy,dimColor,rx+120,sy+2,dimColor)\n    end\n    if flight then\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">MASS</text>',rx+280,sy,dimColor)\n        local ms = flight.mass>1000 and stringf(\"%.1f t\",flight.mass/1000) or stringf(\"%d kg\",flight.mass)\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"white\" font-size=\"20\" font-family=\"monospace\">%s</text>',rx+380,sy+2,ms)\n    end\n    sy=sy+50\n    svg[#svg+1] = stringf('<line x1=\"%d\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke=\"%s\" stroke-width=\"1\"/>',rx,sy-15,rx+560,sy-15,borderColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\" font-weight=\"bold\">ODOMETER</text>',rx+10,sy,accentColor)\n    sy=sy+32\n    if ship then\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">TOTAL DIST</text>',rx+10,sy,dimColor)\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"white\" font-size=\"20\" font-family=\"monospace\">%s</text>',rx+160,sy+2,fmtDist(ship.odo))\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">FLIGHT TIME</text>',rx+300,sy,dimColor)\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"white\" font-size=\"20\" font-family=\"monospace\">%s</text>',rx+450,sy+2,fmtTime(ship.ft))\n    end\n\n    svgFresh(svg,flight,30,SH-45)\n    return svgClose(svg, pageIdx)\nend\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- PAGE 2: RADAR\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlocal radarStateLabels = {[1]=\"OPERATIONAL\",[0]=\"BROKEN\",[-1]=\"JAMMED\",[-2]=\"OBSTRUCTED\",[-3]=\"IN USE\",[-4]=\"NO RADAR\"}\nlocal radarStateColors = {[1]=safeColor,[0]=dangerColor,[-1]=dangerColor,[-2]=warnColor,[-3]=warnColor,[-4]=dimColor}\n\nlocal function contactColor(c,isPvp)\n    if c.f then return safeColor end\n    if c.k==\"Static\" then return staticColor end\n    if isPvp then return c.d<2000 and dangerColor or amberColor end\n    return accentColor\nend\n\nlocal function renderRadar(pageIdx)\n    local radar = safeDecode(\"T_radar\")\n    local flight = safeDecode(\"T_flight\")\n    local ship = safeDecode(\"T_ship\")\n    local svg = {}\n    svgOpen(svg)\n    local isPvp = (ship and ship.pvp) or (radar and radar.pvp)\n    local zl = isPvp and \"PVP ZONE\" or \"SAFE ZONE\"\n    local zc = isPvp and pvpColor or safeColor\n    svgTitle(svg,\"ARCHHUD RADAR\",zl,zc)\n    if not radar then return svgNoData(svg,\"No radar telemetry from databank\",pageIdx) end\n\n    -- Status bar\n    local statusY = 55\n    svg[#svg+1] = stringf('<rect x=\"0\" y=\"%d\" width=\"%d\" height=\"55\" fill=\"%s\"/>',statusY,SW,panelColor)\n    local rState = radar.state or -4\n    local stLabel = radarStateLabels[rState] or \"UNKNOWN\"\n    local stColor = radarStateColors[rState] or dimColor\n    svg[#svg+1] = stringf('<text x=\"40\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">RADAR STATUS</text>',statusY+24,dimColor)\n    svg[#svg+1] = stringf('<circle cx=\"200\" cy=\"%d\" r=\"6\" fill=\"%s\"/>',statusY+20,stColor)\n    svg[#svg+1] = stringf('<text x=\"214\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">%s</text>',statusY+25,stColor,stLabel)\n    local cc = radar.count or 0\n    svg[#svg+1] = stringf('<text x=\"500\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">CONTACTS</text>',statusY+24,dimColor)\n    svg[#svg+1] = stringf('<text x=\"620\" y=\"%d\" fill=\"%s\" font-size=\"22\" font-family=\"monospace\" font-weight=\"bold\">%d</text>',statusY+26,cc>0 and accentColor or dimColor,cc)\n    if isPvp and radar.list then\n        local threats = 0\n        for _,c in ipairs(radar.list) do if not c.f and c.k==\"Dynamic\" then threats=threats+1 end end\n        if threats>0 then\n            svg[#svg+1] = stringf('<text x=\"720\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">THREATS</text>',statusY+24,dimColor)\n            svg[#svg+1] = stringf('<text x=\"830\" y=\"%d\" fill=\"%s\" font-size=\"22\" font-family=\"monospace\" font-weight=\"bold\">%d</text>',statusY+26,dangerColor,threats)\n        end\n    end\n\n    -- Contact table\n    local tableY,rowH,maxRows = 120, 36, 22\n    svg[#svg+1] = stringf('<rect x=\"20\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" stroke=\"%s\" rx=\"6\"/>',tableY,SW-40,SH-tableY-70,panelColor,borderColor)\n    local cN,cNm,cD,cS,cT,cF = 50,110,900,1200,1350,1600\n    local hY = tableY+30\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" font-weight=\"bold\">#</text>',cN,hY,accentColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" font-weight=\"bold\">NAME</text>',cNm,hY,accentColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" font-weight=\"bold\">DISTANCE</text>',cD,hY,accentColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" font-weight=\"bold\">SIZE</text>',cS,hY,accentColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" font-weight=\"bold\">TYPE</text>',cT,hY,accentColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" font-weight=\"bold\">STATUS</text>',cF,hY,accentColor)\n    svg[#svg+1] = stringf('<line x1=\"40\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke=\"%s\" stroke-width=\"1\"/>',hY+8,SW-40,hY+8,borderColor)\n\n    local contacts = radar.list or {}\n    tblSort(contacts, function(a,b) return (a.d or 0)<(b.d or 0) end)\n    local rStartY = hY+14\n    local rendered = 0\n    if #contacts==0 and rState==1 then\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"18\" font-family=\"monospace\" text-anchor=\"middle\">NO CONTACTS DETECTED</text>',SW/2,rStartY+60,dimColor)\n    elseif rState~=1 then\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"18\" font-family=\"monospace\" text-anchor=\"middle\">RADAR %s</text>',SW/2,rStartY+60,stColor,stLabel)\n    else\n        for i,ct in ipairs(contacts) do\n            if rendered>=maxRows then break end\n            local ry = rStartY+(rendered*rowH)\n            local nc = contactColor(ct,isPvp)\n            if rendered%2==0 then svg[#svg+1] = stringf('<rect x=\"30\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" rx=\"2\"/>',ry-2,SW-60,rowH-2,rgba(30,40,55,0.4)) end\n            svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">%d</text>',cN,ry+20,dimColor,i)\n            local nm = esc(ct.n or \"Unknown\"); if #nm>50 then nm=nm:sub(1,47)..\"...\" end\n            svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\">%s</text>',cNm,ry+21,nc,nm)\n            local dc = \"white\"\n            if isPvp and not ct.f and ct.k==\"Dynamic\" then dc = ct.d<2000 and dangerColor or (ct.d<10000 and warnColor or dc) end\n            svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\">%s</text>',cD,ry+21,dc,fmtDist(ct.d or 0))\n            svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\">%s</text>',cS,ry+21,dimColor,ct.s or \"?\")\n            svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\">%s</text>',cT,ry+21,ct.k==\"Dynamic\" and accentColor or staticColor,ct.k or \"?\")\n            svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\">%s</text>',cF,ry+21,ct.f and safeColor or dimColor,ct.f and \"FRIENDLY\" or \"UNKNOWN\")\n            rendered = rendered+1\n        end\n        if #contacts>maxRows then\n            svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" text-anchor=\"middle\">... +%d more</text>',SW/2,rStartY+(maxRows*rowH)+16,dimColor,#contacts-maxRows)\n        end\n    end\n\n    svgFresh(svg,flight,40,SH-45)\n    return svgClose(svg, pageIdx)\nend\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- PAGE 3: DAMAGE\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlocal damageListPage = 0\n\nlocal function integrityColor(pct)\n    pct = mmax(0,mmin(100,pct))\n    if pct>=50 then\n        local t=(pct-50)/50\n        return rgb(mfloor(255-195*t),255,mfloor(120*t))\n    else\n        local t=pct/50\n        return rgb(255,mfloor(60+195*t),mfloor(60-60*t))\n    end\nend\n\nlocal function renderDamage(pageIdx)\n    local damage = safeDecode(\"T_damage\")\n    local flight = safeDecode(\"T_flight\")\n    local svg = {}\n    svgOpen(svg)\n    svgTitle(svg,\"ARCHHUD DAMAGE REPORT\")\n    if flight and flight.time then\n        local age = system.getArkTime()-flight.time\n        local fc = age<15 and safeColor or (age<30 and warnColor or dangerColor)\n        local ft = age<15 and \"LIVE\" or stringf(\"%.0fs AGO\",age)\n        svg[#svg+1] = stringf('<circle cx=\"%d\" cy=\"25\" r=\"5\" fill=\"%s\"/><text x=\"%d\" y=\"30\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" text-anchor=\"end\">DATA: %s</text>',SW-200,fc,SW-20,fc,ft)\n    end\n    if not damage then return svgNoData(svg,\"Damage telemetry published every 10s while seated\",pageIdx) end\n\n    local pct = damage.pct or 0\n    local iColor = integrityColor(pct)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"150\" fill=\"%s\" font-size=\"80\" font-family=\"monospace\" font-weight=\"bold\" text-anchor=\"middle\">%.1f%%</text>',SW/2,iColor,pct)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"178\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" text-anchor=\"middle\">SHIP INTEGRITY</text>',SW/2,dimColor)\n    -- Bar\n    local bx,bY,bW,bH = 40,198,SW-80,24\n    local bf = mmax(0,mfloor(bW*pct/100))\n    svg[#svg+1] = stringf('<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" rx=\"4\"/>',bx,bY,bW,bH,rgba(40,50,60,0.8))\n    if bf>0 then svg[#svg+1] = stringf('<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" rx=\"4\"/>',bx,bY,bf,bH,iColor) end\n    svg[#svg+1] = stringf('<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"none\" stroke=\"%s\" stroke-width=\"1\" rx=\"4\"/>',bx,bY,bW,bH,borderColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"252\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" text-anchor=\"middle\">%d damaged  |  %d disabled  |  %d total</text>',SW/2,dimColor,damage.dmg or 0,damage.off or 0,damage.tot or 0)\n\n    -- Element list\n    local listTop,listBot,listX,listW = 275,SH-60,40,SW-80\n    svg[#svg+1] = stringf('<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" stroke=\"%s\" rx=\"6\"/>',listX-10,listTop-10,listW+20,listBot-listTop+20,panelColor,borderColor)\n    local list = damage.list\n    if not list or #list==0 then\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"30\" font-family=\"monospace\" text-anchor=\"middle\" font-weight=\"bold\">ALL SYSTEMS OPERATIONAL</text>',SW/2,(listTop+listBot)/2,safeColor)\n    else\n        local hdY = listTop+10\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\">ELEMENT</text><text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\">TYPE</text><text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\">HEALTH</text><text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\">HP</text>',\n            listX,hdY,dimColor, listX+520,hdY,dimColor, listX+1050,hdY,dimColor, listX+1560,hdY,dimColor)\n        svg[#svg+1] = stringf('<line x1=\"%d\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke=\"%s\" stroke-width=\"1\"/>',listX,hdY+10,listX+listW,hdY+10,borderColor)\n        local rowHt,contentTop = 50, hdY+20\n        local availH = listBot-contentTop-10\n        local perPage = mmax(1,mfloor(availH/rowHt))\n        local totalPages = mmax(1,mceil(#list/perPage))\n        local pg = damageListPage % totalPages\n        local sIdx = pg*perPage+1\n        local eIdx = mmin(sIdx+perPage-1,#list)\n        local ey = contentTop+20\n        for i=sIdx,eIdx do\n            local el = list[i]\n            if el then\n                local en = esc((el.n or \"Unknown\"):sub(1,34))\n                local et = esc((el.t or \"\"):sub(1,28))\n                local ep = el.mhp>0 and (el.hp/el.mhp*100) or 0\n                local dead = el.hp<=0 or el.off\n                local rc = dead and dangerColor or (ep>=50 and rgb(255,200,50) or rgb(255,130,30))\n                svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\">%s</text>',listX,ey,rc,en)\n                svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\">%s</text>',listX+520,ey,dimColor,et)\n                local hbx,hbw,hbh = listX+1050,460,14\n                svg[#svg+1] = stringf('<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" rx=\"2\"/>',hbx,ey-11,hbw,hbh,rgba(40,50,60,0.8))\n                local hf = mmax(0,mfloor(hbw*ep/100))\n                if hf>0 then svg[#svg+1] = stringf('<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" rx=\"2\"/>',hbx,ey-11,hf,hbh,rc) end\n                if dead then\n                    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" font-weight=\"bold\">DESTROYED</text>',listX+1560,ey,dangerColor)\n                else\n                    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\">%d / %d</text>',listX+1560,ey,dimColor,el.hp,el.mhp)\n                end\n                ey = ey+rowHt\n            end\n        end\n        if totalPages>1 then\n            svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" text-anchor=\"end\">PAGE %d / %d</text>',listX+listW,listBot+5,dimColor,pg+1,totalPages)\n        end\n    end\n    return svgClose(svg, pageIdx)\nend\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- PAGE 4: FLIGHT RECORDER\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlocal MAX_HISTORY = 180\nlocal history = {}\n\nlocal function loadHistory()\n    if db.hasKey(\"T_history\") then\n        local ok,data = pcall(jdecode,db.getStringValue(\"T_history\"))\n        if ok and type(data)==\"table\" then history=data; system.print(stringf(\"Recorder: Loaded %d snapshots.\",#history)) end\n    end\nend\n\nlocal function recordSnapshot()\n    if not db.hasKey(\"T_flight\") then return end\n    local ok,fl = pcall(jdecode,db.getStringValue(\"T_flight\"))\n    if not ok or not fl or not fl.time then return end\n    local n = #history\n    if n>0 and history[n].t>=fl.time then return end\n    history[n+1] = {t=fl.time,s=fl.spd,a=fl.alt,v=fl.vspd}\n    while #history>MAX_HISTORY do table.remove(history,1) end\n    db.setStringValue(\"T_history\",jencode(history))\nend\n\nlocal function drawChart(svg,panelY,panelH,times,values,n,lineColor,chartLabel,fmtLabel,fmtCurr,showZero)\n    local pX,pW = 105,1495\n    local pX2 = pX+pW\n    local plotY,plotH = panelY+34, panelH-44\n    local infoX = 1660\n    svg[#svg+1] = stringf('<rect x=\"15\" y=\"%d\" width=\"1610\" height=\"%d\" fill=\"%s\" stroke=\"%s\" rx=\"6\"/>',panelY,panelH,panelColor,borderColor)\n    svg[#svg+1] = stringf('<text x=\"30\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\" font-weight=\"bold\">%s</text>',panelY+24,accentColor,chartLabel)\n    if n==0 then\n        svg[#svg+1] = stringf('<text x=\"820\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" text-anchor=\"middle\">NO DATA</text>',panelY+panelH/2,dimColor)\n        return\n    end\n    local vmin,vmax = values[1],values[1]\n    for i=2,n do if values[i]<vmin then vmin=values[i] end; if values[i]>vmax then vmax=values[i] end end\n    if showZero then if vmin>0 then vmin=0 end; if vmax<0 then vmax=0 end end\n    local rng = vmax-vmin\n    if rng<0.1 then local ctr=(vmin+vmax)/2; vmin=ctr-1; vmax=ctr+1; rng=2 else vmin=vmin-rng*0.08; vmax=vmax+rng*0.08; rng=vmax-vmin end\n    for i=0,5 do\n        local fr=i/5; local gy=plotY+plotH-fr*plotH; local gv=vmin+fr*rng\n        svg[#svg+1] = stringf('<line x1=\"%d\" y1=\"%.1f\" x2=\"%d\" y2=\"%.1f\" stroke=\"%s\" stroke-width=\"0.5\"/>',pX,gy,pX2,gy,gridColor)\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%.1f\" fill=\"%s\" font-size=\"11\" font-family=\"monospace\" text-anchor=\"end\">%s</text>',pX-8,gy+4,dimColor,fmtLabel(gv))\n    end\n    if showZero and vmin<0 and vmax>0 then\n        local zy=plotY+plotH-((0-vmin)/rng)*plotH\n        svg[#svg+1] = stringf('<line x1=\"%d\" y1=\"%.1f\" x2=\"%d\" y2=\"%.1f\" stroke=\"%s\" stroke-width=\"1\" stroke-dasharray=\"6,4\"/>',pX,zy,pX2,zy,rgba(255,255,255,0.3))\n    end\n    local tS,tE = times[1],times[n]; local tR=tE-tS; if tR<1 then tR=1 end\n    local pts = {}\n    for i=1,n do\n        local xf=(times[i]-tS)/tR; local yf=(values[i]-vmin)/rng\n        pts[i] = stringf(\"%.1f,%.1f\",pX+xf*pW,plotY+plotH-yf*plotH)\n    end\n    svg[#svg+1] = stringf('<polyline points=\"%s\" fill=\"none\" stroke=\"%s\" stroke-width=\"2\" stroke-linejoin=\"round\"/>',tblConcat(pts,\" \"),lineColor)\n    local ex=pX+((times[n]-tS)/tR)*pW; local ey=plotY+plotH-((values[n]-vmin)/rng)*plotH\n    svg[#svg+1] = stringf('<circle cx=\"%.1f\" cy=\"%.1f\" r=\"4\" fill=\"%s\"/>',ex,ey,lineColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\">CURRENT</text>',infoX,panelY+22,dimColor)\n    svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"26\" font-family=\"monospace\" font-weight=\"bold\">%s</text>',infoX,panelY+52,lineColor,fmtCurr(values[n]))\nend\n\nlocal function renderRecorder(pageIdx)\n    local n = #history\n    local now = system.getArkTime()\n    local svg = {}\n    svgOpen(svg)\n    svgTitle(svg,\"ARCHHUD FLIGHT RECORDER\")\n    local isRec = n>0 and (now-history[n].t)<30\n    if isRec then\n        svg[#svg+1] = stringf('<circle cx=\"%d\" cy=\"28\" r=\"6\" fill=\"%s\"/><text x=\"%d\" y=\"34\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">REC</text><text x=\"%d\" y=\"34\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">%d samples</text>',\n            SW-260,dangerColor,SW-248,dangerColor,SW-200,dimColor,n)\n    else\n        svg[#svg+1] = stringf('<circle cx=\"%d\" cy=\"28\" r=\"6\" fill=\"%s\"/><text x=\"%d\" y=\"34\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\">NO DATA</text>',SW-260,rgba(80,80,80,0.8),SW-248,dimColor)\n    end\n\n    local times,speeds,alts,vspeeds = {},{},{},{}\n    for i=1,n do local h=history[i]; times[i]=h.t; speeds[i]=h.s*3.6; alts[i]=h.a; vspeeds[i]=h.v end\n    local cH = 290\n    drawChart(svg,60,cH,times,speeds,n,accentColor,\"SPEED (km/h)\",\n        function(v) return v>10000 and stringf(\"%.1fk\",v/1000) or stringf(\"%.0f\",v) end,\n        function(v) return stringf(\"%.0f km/h\",v) end, false)\n    drawChart(svg,360,cH,times,alts,n,safeColor,\"ALTITUDE\",\n        function(v) return fmtAlt(v) end, function(v) return fmtAlt(v) end, false)\n    drawChart(svg,660,cH,times,vspeeds,n,warnColor,\"VERTICAL SPEED (m/s)\",\n        function(v) return stringf(\"%.1f\",v) end,\n        function(v) return stringf(\"%s%.1f m/s\",v>=0 and \"+\" or \"\",v) end, true)\n\n    -- Time axis\n    if n>1 then\n        local axY,plotX,plotX2 = 960,105,1600\n        local tS,tE = times[1],times[n]; local totalS=tE-tS\n        local ti = totalS>1500 and 300 or (totalS>600 and 120 or (totalS>300 and 60 or 30))\n        svg[#svg+1] = stringf('<line x1=\"%d\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke=\"%s\" stroke-width=\"1\"/>',plotX,axY,plotX2,axY,borderColor)\n        for i=0,mfloor(totalS/ti) do\n            local sa=i*ti; local t=tE-sa\n            if t>=tS then\n                local x=plotX+((t-tS)/totalS)*(plotX2-plotX)\n                svg[#svg+1] = stringf('<line x1=\"%.1f\" y1=\"%d\" x2=\"%.1f\" y2=\"%d\" stroke=\"%s\" stroke-width=\"1\"/>',x,axY,x,axY+8,dimColor)\n                local lb = sa==0 and \"now\" or (sa<60 and stringf(\"%ds\",sa) or stringf(\"%dm\",mfloor(sa/60)))\n                svg[#svg+1] = stringf('<text x=\"%.1f\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\" text-anchor=\"middle\">%s</text>',x,axY+22,dimColor,lb)\n            end\n        end\n    end\n\n    if n>0 then\n        local age=now-history[n].t\n        local fc=age<15 and safeColor or (age<30 and warnColor or dangerColor)\n        svg[#svg+1] = stringf('<circle cx=\"30\" cy=\"%d\" r=\"5\" fill=\"%s\"/><text x=\"42\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\">DATA: %s</text>',\n            SH-40,fc,SH-35,fc,age<15 and \"LIVE\" or stringf(\"%.0fs AGO\",age))\n        local dur=now-history[1].t\n        local dt = dur>3600 and stringf(\"%.1fh recorded\",dur/3600) or (dur>60 and stringf(\"%dm recorded\",mfloor(dur/60)) or stringf(\"%ds recorded\",mfloor(dur)))\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" text-anchor=\"end\">%s</text>',SW-20,SH-35,dimColor,dt)\n    end\n    return svgClose(svg, pageIdx)\nend\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- PAGE 5: ROUTE PLANNER\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlocal routeColor = rgb(100,200,255)\nlocal currentColor = rgb(255,220,50)\nlocal pendingColor = rgba(130,224,255,0.5)\n\nlocal function renderRoute(pageIdx)\n    local route = safeDecode(\"T_route\")\n    local ap = safeDecode(\"T_ap\")\n    local flight = safeDecode(\"T_flight\")\n    local svg = {}\n    svgOpen(svg)\n    svgTitle(svg,\"ARCHHUD ROUTE PLANNER\")\n    if flight and flight.time then\n        local age=system.getArkTime()-flight.time\n        local fc=age<5 and safeColor or (age<15 and warnColor or dangerColor)\n        svg[#svg+1] = stringf('<circle cx=\"%d\" cy=\"25\" r=\"5\" fill=\"%s\"/><text x=\"%d\" y=\"30\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" text-anchor=\"end\">DATA: %s</text>',\n            SW-200,fc,SW-20,fc,age<5 and \"LIVE\" or stringf(\"%.0fs AGO\",age))\n    end\n    if not route then return svgNoData(svg,\"Route telemetry published every 3s while seated\",pageIdx) end\n\n    if not route.active then\n        svg[#svg+1] = stringf('<rect x=\"40\" y=\"80\" width=\"%d\" height=\"200\" fill=\"%s\" stroke=\"%s\" rx=\"8\"/>',SW-80,panelColor,borderColor)\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"170\" fill=\"%s\" font-size=\"32\" font-family=\"monospace\" text-anchor=\"middle\" font-weight=\"bold\">NO ACTIVE ROUTE</text>',SW/2,dimColor)\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"210\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" text-anchor=\"middle\">Select a target and use ALT+SHIFT+8 to add waypoints</text>',SW/2,pendingColor)\n        if route.saved and route.savedCount and route.savedCount>0 then\n            svg[#svg+1] = stringf('<text x=\"%d\" y=\"250\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" text-anchor=\"middle\">Saved route: %d waypoints</text>',SW/2,safeColor,route.savedCount)\n        end\n        if ap then\n            svg[#svg+1] = stringf('<text x=\"40\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">AP TARGET: %s</text>',SH-40,ap.on and safeColor or dimColor,esc(ap.tgt or \"None\"))\n        end\n        return svgClose(svg, pageIdx)\n    end\n\n    local wps = route.wps or {}\n    local wpCount = route.count or #wps\n    local progress = route.progress or 0\n    local spd = route.spd or 0\n\n    -- Overview panel\n    local ovY,ovH = 60,130\n    svg[#svg+1] = stringf('<rect x=\"20\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" stroke=\"%s\" rx=\"6\"/>',ovY,SW-40,ovH,panelColor,borderColor)\n    svg[#svg+1] = stringf('<text x=\"50\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">ROUTE PROGRESS</text>',ovY+28,dimColor)\n    svg[#svg+1] = stringf('<text x=\"260\" y=\"%d\" fill=\"%s\" font-size=\"28\" font-family=\"monospace\" font-weight=\"bold\">%.1f%%</text>',ovY+30,accentColor,progress)\n    local pbX,pbY,pbW,pbH = 50,ovY+42,SW-100,20\n    local pbF = mmax(0,mfloor(pbW*progress/100))\n    svg[#svg+1] = stringf('<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" rx=\"4\"/>',pbX,pbY,pbW,pbH,rgba(40,50,60,0.8))\n    if pbF>0 then svg[#svg+1] = stringf('<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" rx=\"4\"/>',pbX,pbY,pbF,pbH,accentColor) end\n    svg[#svg+1] = stringf('<rect x=\"%d\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"none\" stroke=\"%s\" rx=\"4\"/>',pbX,pbY,pbW,pbH,borderColor)\n    for i=1,wpCount do\n        local mx=pbX+mfloor(pbW*(i/wpCount))\n        local mc = wps[i] and wps[i].cur and currentColor or rgba(255,255,255,0.4)\n        svg[#svg+1] = stringf('<line x1=\"%d\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke=\"%s\" stroke-width=\"1\"/>',mx,pbY,mx,pbY+pbH,mc)\n    end\n    local sY = pbY+pbH+22\n    svg[#svg+1] = stringf('<text x=\"50\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\">TOTAL</text><text x=\"50\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">%s</text>',sY,dimColor,sY+18,accentColor,fmtDist(route.totalDist))\n    svg[#svg+1] = stringf('<text x=\"350\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\">REMAINING</text><text x=\"350\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">%s</text>',sY,dimColor,sY+18,warnColor,fmtDist(route.remainDist))\n    svg[#svg+1] = stringf('<text x=\"700\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\">ETA</text><text x=\"700\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">%s</text>',sY,dimColor,sY+18,safeColor,fmtTime(route.remainEta))\n    svg[#svg+1] = stringf('<text x=\"1000\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\">SPEED</text><text x=\"1000\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">%s</text>',sY,dimColor,sY+18,accentColor,fmtSpeed(spd))\n    svg[#svg+1] = stringf('<text x=\"1350\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\">WAYPOINTS</text><text x=\"1350\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">%d</text>',sY,dimColor,sY+18,accentColor,wpCount)\n    local apOn = ap and ap.on\n    svg[#svg+1] = stringf('<text x=\"1600\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\">AUTOPILOT</text><text x=\"1600\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">%s</text>',sY,dimColor,sY+18,apOn and safeColor or dimColor,apOn and \"ACTIVE\" or \"OFF\")\n\n    -- Waypoint list\n    local ltop = ovY+ovH+15\n    local lbot = SH-70\n    svg[#svg+1] = stringf('<rect x=\"20\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" stroke=\"%s\" rx=\"6\"/>',ltop,SW-40,lbot-ltop,panelColor,borderColor)\n    local hdY = ltop+25\n    svg[#svg+1] = stringf('<text x=\"70\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" font-weight=\"bold\">#</text><text x=\"140\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" font-weight=\"bold\">WAYPOINT</text><text x=\"850\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" font-weight=\"bold\">PLANET</text><text x=\"1100\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" font-weight=\"bold\">LEG DIST</text><text x=\"1350\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" font-weight=\"bold\">FROM SHIP</text><text x=\"1650\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" font-weight=\"bold\">ETA</text>',\n        hdY,accentColor,hdY,accentColor,hdY,accentColor,hdY,accentColor,hdY,accentColor,hdY,accentColor)\n    svg[#svg+1] = stringf('<line x1=\"35\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke=\"%s\" stroke-width=\"1\"/>',hdY+10,SW-55,hdY+10,borderColor)\n\n    local rowHt = 58\n    local rowSY = hdY+20\n    local maxR = mfloor((lbot-rowSY-10)/rowHt)\n    local connX = 55\n    for i=1,mmin(wpCount,maxR) do\n        local wp = wps[i]; if not wp then break end\n        local ry = rowSY+((i-1)*rowHt)\n        local isCur = wp.cur\n        local nm = esc(wp.n or \"Unknown\"); if #nm>42 then nm=nm:sub(1,40)..\"..\" end\n        local planet = esc(wp.p or \"\")\n        local legD = fmtDist(wp.leg)\n        local shipD = fmtDist(wp.d)\n        local eta = \"---\"\n        if spd>1 and wp.d and wp.d>0 then eta = fmtTime(wp.d/spd) end\n        local nodeC,nameC,txtC\n        if isCur then\n            nodeC,nameC,txtC = currentColor,currentColor,\"white\"\n            svg[#svg+1] = stringf('<rect x=\"25\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" rx=\"3\"/>',ry-8,SW-50,rowHt-4,rgba(255,220,50,0.08))\n        else nodeC,nameC,txtC = pendingColor,pendingColor,dimColor end\n        if i<wpCount and i<maxR then\n            svg[#svg+1] = stringf('<line x1=\"%d\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke=\"%s\" stroke-width=\"2\" stroke-dasharray=\"4,4\"/>',connX,ry+14,connX,ry+rowHt-8,rgba(130,224,255,0.2))\n        end\n        if isCur then\n            svg[#svg+1] = stringf('<circle cx=\"%d\" cy=\"%d\" r=\"14\" fill=\"none\" stroke=\"%s\" stroke-width=\"2\"/><circle cx=\"%d\" cy=\"%d\" r=\"8\" fill=\"%s\"/>',connX,ry+2,currentColor,connX,ry+2,currentColor)\n            svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"11\" font-family=\"monospace\" text-anchor=\"middle\">%d</text>',connX,ry+5,rgb(12,16,22),i)\n        else\n            svg[#svg+1] = stringf('<circle cx=\"%d\" cy=\"%d\" r=\"12\" fill=\"none\" stroke=\"%s\" stroke-width=\"1.5\"/><text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\" text-anchor=\"middle\">%d</text>',connX,ry+2,nodeC,connX,ry+6,nodeC,i)\n        end\n        svg[#svg+1] = stringf('<text x=\"140\" y=\"%d\" fill=\"%s\" font-size=\"17\" font-family=\"monospace\"%s>%s</text>',ry+6,nameC,isCur and ' font-weight=\"bold\"' or \"\",nm)\n        if isCur then svg[#svg+1] = stringf('<text x=\"140\" y=\"%d\" fill=\"%s\" font-size=\"11\" font-family=\"monospace\">CURRENT TARGET</text>',ry+22,currentColor) end\n        svg[#svg+1] = stringf('<text x=\"850\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\">%s</text>',ry+6,txtC,planet)\n        svg[#svg+1] = stringf('<text x=\"1100\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\">%s</text>',ry+6,txtC,legD)\n        svg[#svg+1] = stringf('<text x=\"1350\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\"%s>%s</text>',ry+6,isCur and currentColor or txtC,isCur and ' font-weight=\"bold\"' or \"\",shipD)\n        svg[#svg+1] = stringf('<text x=\"1650\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\">%s</text>',ry+6,isCur and safeColor or txtC,eta)\n    end\n    if wpCount>maxR then\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" text-anchor=\"middle\">... +%d more</text>',SW/2,lbot-10,dimColor,wpCount-maxR)\n    end\n\n    -- Footer\n    local tgtN = route.tgt or (ap and ap.tgt) or \"None\"\n    svg[#svg+1] = stringf('<text x=\"40\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\">TARGET: %s</text>',SH-40,accentColor,esc(tgtN))\n    if route.saved then\n        svg[#svg+1] = stringf('<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\" text-anchor=\"end\">SAVED: %d WP</text>',SW-40,SH-40,dimColor,route.savedCount or 0)\n    end\n    return svgClose(svg, pageIdx)\nend\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- ALERT CHECKS (run every tick)\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlocal prevIntegrity = 100\nlocal prevDisabled = 0\nlocal prevContactIds = {}\nlocal prevThreatClose = 0\n\nlocal function checkDamageAlerts()\n    local damage = safeDecode(\"T_damage\")\n    if not damage then return end\n    local pct = damage.pct or 100\n    local off = damage.off or 0\n    local alertMsg = nil\n    if pct<25 and prevIntegrity>=25 then alertMsg = stringf(\"CRITICAL: Hull integrity %.0f%% - %d disabled\",pct,off)\n    elseif pct<50 and prevIntegrity>=50 then alertMsg = stringf(\"WARNING: Hull integrity %.0f%% - %d damaged\",pct,damage.dmg or 0)\n    elseif pct<75 and prevIntegrity>=75 then alertMsg = stringf(\"Hull integrity %.0f%% - taking damage\",pct) end\n    if off>prevDisabled then alertMsg = stringf(\"ALERT: %d element(s) destroyed! %d total disabled\",off-prevDisabled,off) end\n    prevIntegrity = pct; prevDisabled = off\n    if alertMsg then db.setStringValue(\"A_damage\",jencode({msg=alertMsg,t=system.getArkTime()})) end\nend\n\nlocal function checkRadarAlerts()\n    local radar = safeDecode(\"T_radar\")\n    if not radar or not radar.list then return end\n    local isPvp,contacts = radar.pvp, radar.list\n    local alertMsg,threatClose = nil, 0\n    local currentIds = {}\n    for _,c in ipairs(contacts) do\n        local key=(c.n or \"?\")..\"_\"..(c.s or \"?\"); currentIds[key]=true\n        if isPvp and not c.f and c.k==\"Dynamic\" and c.d<2000 then threatClose=threatClose+1 end\n    end\n    if threatClose>prevThreatClose and isPvp then alertMsg=stringf(\"THREAT: %d hostile(s) within 2 km!\",threatClose-prevThreatClose) end\n    if not alertMsg then\n        for _,c in ipairs(contacts) do\n            if c.k==\"Dynamic\" and not c.f then\n                local key=(c.n or \"?\")..\"_\"..(c.s or \"?\")\n                if not prevContactIds[key] then\n                    alertMsg=stringf(\"Radar: New contact '%s' at %s%s\",c.n or \"Unknown\",fmtDist(c.d or 0),isPvp and \" in PVP zone\" or \"\"); break\n                end\n            end\n        end\n    end\n    prevContactIds=currentIds; prevThreatClose=threatClose\n    if alertMsg then db.setStringValue(\"A_radar\",jencode({msg=alertMsg,t=system.getArkTime()})) end\nend\n\nlocal function checkRecorderAlerts()\n    local n = #history\n    if n<4 then return end\n    local cur,prev = history[n], history[n-3]\n    local alertMsg = nil\n    if prev.a and cur.a and prev.a>500 then\n        local drop=prev.a-cur.a; if drop>1000 then alertMsg=stringf(\"ALERT: Rapid altitude loss! -%dm in 30s\",mfloor(drop)) end\n    end\n    if prev.s and cur.s and prev.s>100 then\n        if prev.s-cur.s > prev.s*0.5 then alertMsg=stringf(\"ALERT: Sudden deceleration! %.0f -> %.0f m/s\",prev.s,cur.s) end\n    end\n    if alertMsg then db.setStringValue(\"A_recorder\",jencode({msg=alertMsg,t=system.getArkTime()})) end\nend\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- PAGE DISPATCHER\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nlocal renderers = {renderTelemetry, renderRadar, renderDamage, renderRecorder, renderRoute}\n\nlocal function renderPage(pageIdx)\n    local r = renderers[pageIdx]\n    if r then return r(pageIdx) end\n    return \"\"\nend\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- SCREEN CLICK NAVIGATION\n-- In screen > onMouseDown(x,y):  onScreenNav(1,x)\n-- In screen2 > onMouseDown(x,y): onScreenNav(2,x)\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction onScreenNav(screenNum, x)\n    if screenNum == 1 then\n        if x > 0.5 then screen1Page = (screen1Page % pageCount) + 1\n        else screen1Page = ((screen1Page - 2) % pageCount) + 1 end\n        if screen then screen.setHTML(renderPage(screen1Page)) end\n    elseif screenNum == 2 and screen2 then\n        if x > 0.5 then screen2Page = (screen2Page % pageCount) + 1\n        else screen2Page = ((screen2Page - 2) % pageCount) + 1 end\n        screen2.setHTML(renderPage(screen2Page))\n    end\nend\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- TIMER CALLBACK\n-- In unit > onTimer(timerId):  onBoardTick(timerId)\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction onBoardTick(timerId)\n    if timerId == \"refresh\" then\n        -- Flight recorder snapshots\n        recorderTicks = recorderTicks + 1\n        if recorderTicks >= RECORDER_TICKS then\n            recordSnapshot()\n            recorderTicks = 0\n        end\n        -- Damage page auto-advances element list\n        damageListPage = damageListPage + 1\n        -- Alert checks\n        checkDamageAlerts()\n        checkRadarAlerts()\n        checkRecorderAlerts()\n        -- Refresh current page on each screen\n        if screen and db then screen.setHTML(renderPage(screen1Page)) end\n        if screen2 and db then screen2.setHTML(renderPage(screen2Page)) end\n    end\nend\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- STOP HANDLER\n-- In unit > onStop:  onBoardStop()\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nfunction onBoardStop()\n    if screen then screen.setHTML(\"\") end\n    if screen2 then screen2.setHTML(\"\") end\nend\n\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n-- AUTO-INITIALIZATION\n-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nif not db then\n    system.print(\"ArchHUD Display: No databank. Rename databank slot to 'db'.\")\n    return\nend\nif not screen then\n    system.print(\"ArchHUD Display: No screen. Rename screen slot to 'screen'.\")\n    return\nend\nloadHistory()\nunit.setTimer(\"refresh\", TICK_INTERVAL)\nlocal mode = screen2 and \"2 screens\" or \"1 screen\"\nsystem.print(stringf(\"ArchHUD Combined Display started. %d pages, %s. Click screen to navigate.\", pageCount, mode))\nscreen.setHTML(renderPage(screen1Page))\nif screen2 then screen2.setHTML(renderPage(screen2Page)) end\n",
      "filter": {
        "args": [],
        "signature": "start()",
        "slotKey": "-1"
      },
      "key": "0"
    },
    {
      "code": "onBoardTick(timerId)",
      "filter": {
        "args": [],
        "signature": "tick(timerId)",
        "slotKey": "-1"
      },
      "key": "1"
    },
    {
      "code": "onBoardStop()",
      "filter": {
        "args": [],
        "signature": "stop()",
        "slotKey": "-1"
      },
      "key": "2"
    },
    {
      "code": "onScreenNav(1,x)",
      "filter": {
        "args": [],
        "signature": "mouseDown(x,y)",
        "slotKey": "1"
      },
      "key": "3"
    },
    {
      "code": "onScreenNav(2,x)",
      "filter": {
        "args": [],
        "signature": "mouseDown(x,y)",
        "slotKey": "2"
      },
      "key": "4"
    }
  ],
  "methods": [],
  "events": []
}