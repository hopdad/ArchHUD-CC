{
  "slots": {
    "0": {
      "name": "db",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "1": {
      "name": "screen",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "2": {
      "name": "screen2",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "-1": {
      "name": "unit",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "-2": {
      "name": "system",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "-3": {
      "name": "library",
      "type": {
        "events": [],
        "methods": []
      }
    }
  },
  "handlers": [
    {
      "code": "-- ArchHUD Combined Display - Programming Board Script\n-- All-in-one display: Telemetry, Radar, Damage, Flight Recorder, Route Planner.\n-- Uses setRenderScript for native DU screen rendering.\n-- Click left/right side of screen to navigate between pages.\n-- Supports 1 or 2 screens, each independently navigable.\n--\n-- ═══════════════════════════════════════════════════════\n-- SETUP: Use CombinedDisplay.json (Paste Lua configuration)\n-- or manually:\n--   Slots: db=databank, screen=ScreenUnit, screen2=ScreenUnit (optional)\n--   unit > onStart       → paste this entire script\n--   unit > onTimer(timerId) → onBoardTick(timerId)\n--   unit > onStop        → onBoardStop()\n-- ═══════════════════════════════════════════════════════\n\nlocal db = db           ---@type databank\nlocal screen = screen   ---@type ScreenUnit\nlocal screen2 = screen2 ---@type ScreenUnit\nlocal unit = unit       ---@type ProgrammingBoard\nlocal system = system\n\n-- ═══════════════════════════════════════════\n-- Configuration\n-- ═══════════════════════════════════════════\nlocal TICK_INTERVAL = 2\nlocal RECORDER_TICKS = 5\n\n-- ═══════════════════════════════════════════\n-- Cached stdlib\n-- ═══════════════════════════════════════════\nlocal jdecode = json.decode\nlocal jencode = json.encode\nlocal mfloor = math.floor\nlocal mmin = math.min\nlocal mmax = math.max\nlocal stringf = string.format\n\n-- ═══════════════════════════════════════════\n-- State\n-- ═══════════════════════════════════════════\nlocal recorderTicks = 0\nlocal MAX_HISTORY = 180\nlocal history = {}\nlocal prevIntegrity = 100\nlocal prevDisabled = 0\nlocal prevContactIds = {}\nlocal prevThreatClose = 0\n\n-- ═══════════════════════════════════════════\n-- Utilities\n-- ═══════════════════════════════════════════\nlocal function safeDecode(key)\n    if not db.hasKey(key) then return nil end\n    local ok, r = pcall(jdecode, db.getStringValue(key))\n    if ok then return r end\n    return nil\nend\n\nlocal function fmtDist(m)\n    if not m or m == 0 then return \"---\" end\n    if m > 200000 then return stringf(\"%.2f su\",m/200000)\n    elseif m > 10000 then return stringf(\"%.1f km\",m/1000)\n    elseif m > 1000 then return stringf(\"%.2f km\",m/1000)\n    else return stringf(\"%.0f m\",m) end\nend\n\n-- ═══════════════════════════════════════════\n-- Flight Recorder\n-- ═══════════════════════════════════════════\nlocal function loadHistory()\n    if db.hasKey(\"T_history\") then\n        local ok,data = pcall(jdecode,db.getStringValue(\"T_history\"))\n        if ok and type(data)==\"table\" then history=data; system.print(stringf(\"Recorder: Loaded %d snapshots.\",#history)) end\n    end\nend\n\nlocal function recordSnapshot()\n    if not db.hasKey(\"T_flight\") then return end\n    local ok,fl = pcall(jdecode,db.getStringValue(\"T_flight\"))\n    if not ok or not fl or not fl.time then return end\n    local n = #history\n    if n>0 and history[n].t>=fl.time then return end\n    history[n+1] = {t=fl.time,s=fl.spd,a=fl.alt,v=fl.vspd}\n    while #history>MAX_HISTORY do table.remove(history,1) end\n    db.setStringValue(\"T_history\",jencode(history))\nend\n\n-- ═══════════════════════════════════════════\n-- Alert Checks\n-- ═══════════════════════════════════════════\nlocal function checkDamageAlerts()\n    local damage = safeDecode(\"T_damage\")\n    if not damage then return end\n    local pct = damage.pct or 100\n    local off = damage.off or 0\n    local alertMsg = nil\n    if pct<25 and prevIntegrity>=25 then alertMsg = stringf(\"CRITICAL: Hull integrity %.0f%% - %d disabled\",pct,off)\n    elseif pct<50 and prevIntegrity>=50 then alertMsg = stringf(\"WARNING: Hull integrity %.0f%% - %d damaged\",pct,damage.dmg or 0)\n    elseif pct<75 and prevIntegrity>=75 then alertMsg = stringf(\"Hull integrity %.0f%% - taking damage\",pct) end\n    if off>prevDisabled then alertMsg = stringf(\"ALERT: %d element(s) destroyed! %d total disabled\",off-prevDisabled,off) end\n    prevIntegrity = pct; prevDisabled = off\n    if alertMsg then db.setStringValue(\"A_damage\",jencode({msg=alertMsg,t=system.getArkTime()})) end\nend\n\nlocal function checkRadarAlerts()\n    local radar = safeDecode(\"T_radar\")\n    if not radar or not radar.list then return end\n    local isPvp,contacts = radar.pvp, radar.list\n    local alertMsg,threatClose = nil, 0\n    local currentIds = {}\n    for _,c in ipairs(contacts) do\n        local key=(c.n or \"?\")..\"_\"..(c.s or \"?\"); currentIds[key]=true\n        if isPvp and not c.f and c.k==\"Dynamic\" and c.d<2000 then threatClose=threatClose+1 end\n    end\n    if threatClose>prevThreatClose and isPvp then alertMsg=stringf(\"THREAT: %d hostile(s) within 2 km!\",threatClose-prevThreatClose) end\n    if not alertMsg then\n        for _,c in ipairs(contacts) do\n            if c.k==\"Dynamic\" and not c.f then\n                local key=(c.n or \"?\")..\"_\"..(c.s or \"?\")\n                if not prevContactIds[key] then\n                    alertMsg=stringf(\"Radar: New contact '%s' at %s%s\",c.n or \"Unknown\",fmtDist(c.d or 0),isPvp and \" in PVP zone\" or \"\"); break\n                end\n            end\n        end\n    end\n    prevContactIds=currentIds; prevThreatClose=threatClose\n    if alertMsg then db.setStringValue(\"A_radar\",jencode({msg=alertMsg,t=system.getArkTime()})) end\nend\n\nlocal function checkRecorderAlerts()\n    local n = #history\n    if n<4 then return end\n    local cur,prev = history[n], history[n-3]\n    local alertMsg = nil\n    if prev.a and cur.a and prev.a>500 then\n        local drop=prev.a-cur.a; if drop>1000 then alertMsg=stringf(\"ALERT: Rapid altitude loss! -%dm in 30s\",mfloor(drop)) end\n    end\n    if prev.s and cur.s and prev.s>100 then\n        if prev.s-cur.s > prev.s*0.5 then alertMsg=stringf(\"ALERT: Sudden deceleration! %.0f -> %.0f m/s\",prev.s,cur.s) end\n    end\n    if alertMsg then db.setStringValue(\"A_recorder\",jencode({msg=alertMsg,t=system.getArkTime()})) end\nend\n\n-- ═══════════════════════════════════════════\n-- Data Collection (sent to screen via setScriptInput)\n-- setScriptInput has a 1024-char limit, so only send data for the active page.\n-- The render script outputs its current page number via setOutput().\n-- ═══════════════════════════════════════════\nlocal function collectDataForPage(pg)\n    local data = {ts = system.getArkTime()}\n    if pg == 2 then\n        -- Radar page: contacts + pvp status\n        local radar = safeDecode(\"T_radar\")\n        if radar and radar.list then\n            local lim = {}\n            for i = 1, mmin(#radar.list, 8) do lim[i] = radar.list[i] end\n            radar.list = lim\n        end\n        data.r = radar\n        local ship = safeDecode(\"T_ship\")\n        if ship then data.s = {pvp = ship.pvp} end\n    elseif pg == 3 then\n        -- Damage page: element list\n        local damage = safeDecode(\"T_damage\")\n        if damage and damage.list then\n            local lim = {}\n            for i = 1, mmin(#damage.list, 10) do lim[i] = damage.list[i] end\n            damage.list = lim\n        end\n        data.d = damage\n    elseif pg == 4 then\n        -- Recorder page: compact history arrays [t,s,a,v]\n        local flight = safeDecode(\"T_flight\")\n        if flight then data.f = {time = flight.time} end\n        local hData = {}\n        local n = #history\n        if n > 0 then\n            local step = mmax(1, mfloor(n / 25))\n            for i = 1, n, step do\n                local p = history[i]\n                hData[#hData + 1] = {mfloor(p.t), mfloor((p.s or 0) + 0.5), mfloor((p.a or 0) + 0.5), mfloor((p.v or 0) + 0.5)}\n            end\n            local last = history[n]\n            if #hData == 0 or hData[#hData][1] ~= mfloor(last.t) then\n                hData[#hData + 1] = {mfloor(last.t), mfloor((last.s or 0) + 0.5), mfloor((last.a or 0) + 0.5), mfloor((last.v or 0) + 0.5)}\n            end\n        end\n        data.h = hData\n    elseif pg == 5 then\n        -- Route page: waypoints + AP status\n        data.rt = safeDecode(\"T_route\")\n        local ap = safeDecode(\"T_ap\")\n        if ap then data.a = {on = ap.on} end\n    else\n        -- Page 1 (Telemetry) or default\n        data.f = safeDecode(\"T_flight\")\n        data.a = safeDecode(\"T_ap\")\n        data.s = safeDecode(\"T_ship\")\n        data.u = safeDecode(\"T_fuel\")\n    end\n    return jencode(data)\nend\n\n-- ═══════════════════════════════════════════\n-- RENDER SCRIPT (runs on screen unit)\n-- ═══════════════════════════════════════════\nlocal RENDER_SCRIPT = [=[\n-- ArchHUD Combined Display Render Script\n-- Minimal JSON decoder\nlocal function J(s)\n  if not s or s==\"\" then return nil end\n  local i=1\n  local V\n  local function w()while i<=#s and s:byte(i)<=32 do i=i+1 end end\n  local function S()\n    i=i+1 local b={}\n    while true do\n      local c=s:sub(i,i)\n      if c=='\"' then break\n      elseif c=='\\\\' then i=i+1;c=s:sub(i,i);if c=='n' then b[#b+1]='\\n' elseif c=='t' then b[#b+1]='\\t' else b[#b+1]=c end\n      else b[#b+1]=c end\n      i=i+1\n    end\n    i=i+1;return table.concat(b)\n  end\n  V=function()\n    w();local c=s:sub(i,i)\n    if c=='\"' then return S()\n    elseif c=='{' then\n      i=i+1;w();local t={}\n      if s:sub(i,i)~='}' then\n        local k=S();w();i=i+1;t[k]=V()\n        while true do w();if s:sub(i,i)~=',' then break end;i=i+1;k=S();w();i=i+1;t[k]=V() end\n      end;w();i=i+1;return t\n    elseif c=='[' then\n      i=i+1;w();local t={}\n      if s:sub(i,i)~=']' then\n        t[1]=V();local n=1\n        while true do w();if s:sub(i,i)~=',' then break end;i=i+1;n=n+1;t[n]=V() end\n      end;w();i=i+1;return t\n    elseif c=='t' then i=i+4;return true\n    elseif c=='f' then i=i+5;return false\n    elseif c=='n' then i=i+4;return nil\n    else local j=i;if c=='-' then i=i+1 end;while i<=#s and s:sub(i,i):match('[%deE%.%+%-]') do i=i+1 end;return tonumber(s:sub(j,i-1))\n    end\n  end\n  local ok,r=pcall(V);return ok and r or nil\nend\n\n-- Persistent state (globals survive between frames)\npage = page or 1\ndmgPg = dmgPg or 0\ndmgTmr = dmgTmr or 0\nlocal PAGES = 5\nlocal pgN = {\"TELEMETRY\",\"RADAR\",\"DAMAGE\",\"RECORDER\",\"ROUTE\"}\n\n-- Resolution\nlocal rx, ry = getResolution()\nlocal hw = rx/2\n\n-- Fonts (cached across frames via globals)\nfH = fH or loadFont(\"Play-Bold\",14)\nfN = fN or loadFont(\"FiraMono\",12)\nfL = fL or loadFont(\"FiraMono\",18)\nfS = fS or loadFont(\"FiraMono\",9)\nfXL = fXL or loadFont(\"FiraMono-Bold\",24)\n\n-- Parse input (cache to avoid re-parsing same data)\nlocal raw = getInput() or \"\"\nif raw ~= _lastRaw then _lastRaw = raw; _D = J(raw) end\nlocal D = _D or {}\nlocal f = D.f or {}\nlocal a = D.a or {}\nlocal s = D.s or {}\nlocal u = D.u or {}\nlocal r = D.r or {}\nlocal d = D.d or {}\nlocal rt = D.rt or {}\nlocal h = D.h or {}\nlocal ts = D.ts or 0\n\n-- Click navigation\nlocal mx, my = getCursor()\nif getCursorPressed() and my < ry-22 and mx >= 0 then\n  if mx > hw then page = page%PAGES+1 else page = (page-2)%PAGES+1 end\nend\n\n-- Layers\nlocal bg = createLayer()\nlocal L = createLayer()\nlocal ov = createLayer()\n\n-- Background\nsetBackgroundColor(0.047,0.063,0.086)\n\n-- Stdlib\nlocal floor,fmt,min,max = math.floor,string.format,math.min,math.max\n\n-- Colors (RGBA 0-1)\nlocal cA={0.51,0.88,1,1}     local cD={0.35,0.61,0.71,1}\nlocal cW={1,0.65,0,1}        local cR={1,0.24,0.24,1}\nlocal cS={0.24,1,0.47,1}     local cT={0.86,0.88,0.90,1}\nlocal cP={0.08,0.12,0.16,0.85} local cB={0.51,0.88,1,0.3}\nlocal cG={0.51,0.88,1,0.12}  local cSt={0.39,0.43,0.49,1}\nlocal cAm={1,0.75,0.20,1}    local cCu={1,0.86,0.20,1}\n\n-- Helpers\nlocal function fc(l,c) setNextFillColor(l,c[1],c[2],c[3],c[4]) end\nlocal function sc(l,c) setNextStrokeColor(l,c[1],c[2],c[3],c[4]) end\nlocal function pnl(l,x,y,w,h) fc(l,cP);sc(l,cB);setNextStrokeWidth(l,1);addBoxRounded(l,x,y,w,h,4) end\nlocal function lbl(l,x,y,t) fc(l,cD);addText(l,fN,t,x,y) end\nlocal function val(l,x,y,t,c) fc(l,c or cT);addText(l,fL,t,x,y) end\nlocal function hdr(l,x,y,t) fc(l,cA);addText(l,fH,t,x,y) end\nlocal function stp(l,x,y,on,t)\n  if on then setNextFillColor(l,0.24,1,0.47,1) else setNextFillColor(l,0.24,0.27,0.31,0.8) end\n  addCircle(l,x,y,3)\n  fc(l,on and cA or cD);addText(l,fS,t,x+7,y-4)\nend\nlocal function br(l,x,y,w,h,pct,c)\n  pct=max(0,min(100,pct or 0))\n  setNextFillColor(l,0.16,0.20,0.24,0.8);addBoxRounded(l,x,y,w,h,2)\n  if pct>0 then fc(l,c or cA);addBoxRounded(l,x,y,max(1,floor(w*pct/100)),h,2) end\nend\n\n-- Formatting\nlocal function fD(m)\n  if not m or m==0 then return \"---\" end\n  if m>200000 then return fmt(\"%.2f su\",m/200000)\n  elseif m>10000 then return fmt(\"%.1f km\",m/1000)\n  elseif m>1000 then return fmt(\"%.2f km\",m/1000)\n  else return fmt(\"%.0f m\",m) end\nend\nlocal function fT(sec)\n  if not sec or sec<=0 then return \"---\" end\n  local dd=floor(sec/86400) local hh=floor((sec%86400)/3600) local mm=floor((sec%3600)/60) local ss=floor(sec%60)\n  if dd>365 then return \">1y\" elseif dd>0 then return fmt(\"%dd %dh\",dd,hh)\n  elseif hh>0 then return fmt(\"%dh %dm\",hh,mm) elseif mm>0 then return fmt(\"%dm %ds\",mm,ss) else return fmt(\"%ds\",ss) end\nend\nlocal function fS(mps) return fmt(\"%.0f km/h\",(mps or 0)*3.6) end\nlocal function fMs(mps) mps=mps or 0;if mps>1000 then return fmt(\"%.1f km/s\",mps/1000) end;return fmt(\"%.0f m/s\",mps) end\nlocal function fA(m) m=m or 0;if m>100000 then return fmt(\"%.2f su\",m/200000) elseif m>1000 then return fmt(\"%.1f km\",m/1000) else return fmt(\"%.0f m\",m) end end\n\n-- Title bar\nlocal function titleBar(title,rtxt,rc)\n  setNextFillColor(bg,0.08,0.12,0.16,0.95);addBox(bg,0,0,rx,30)\n  fc(ov,cA);addText(ov,fH,title,8,7)\n  if rtxt then fc(ov,rc or cD);setNextTextAlign(ov,AlignH_Right,AlignV_Top);addText(ov,fN,rtxt,rx-8,10) end\nend\n\n-- Freshness indicator\nlocal function fresh(l,x,y)\n  if f.time and ts>0 then\n    local age=ts-(f.time or 0)\n    local c=age<5 and cS or (age<15 and cW or cR)\n    local t=age<5 and \"LIVE\" or fmt(\"%.0fs AGO\",age)\n    fc(l,c);addCircle(l,x,y+4,3);fc(l,c);addText(l,fS,t == nil and \"\" or (\"DATA: \"..t),x+8,y)\n  end\nend\n\n-- No data screen\nlocal function noData(msg)\n  fc(L,cW);setNextTextAlign(L,AlignH_Center,AlignV_Middle);addText(L,fL,\"AWAITING DATA\",hw,ry/2-10)\n  fc(L,cD);setNextTextAlign(L,AlignH_Center,AlignV_Middle);addText(L,fN,msg or \"\",hw,ry/2+12)\nend\n\n-- ═════════ PAGE 1: TELEMETRY ═════════\nlocal function pgTelemetry()\n  local pvp=s.pvp;titleBar(\"ARCHHUD TELEMETRY\",pvp and \"PVP ZONE\" or \"SAFE ZONE\",pvp and cR or cS)\n  if not f.spd then noData(\"Link databank to same databank as ArchHUD seat\");return end\n  local pw=hw-12;local x1,x2=6,hw+6;local y1=34\n  -- Flight panel\n  pnl(L,x1,y1,pw,165);hdr(L,x1+6,y1+6,\"FLIGHT DATA\")\n  local fy=y1+26;lbl(L,x1+6,fy,\"SPEED\");val(L,x1+62,fy,fS(f.spd));fc(L,cD);addText(L,fS,\"(\"..fMs(f.spd)..\")\",x1+220,fy+4)\n  fy=fy+22;lbl(L,x1+6,fy,\"ALT\");val(L,x1+62,fy,fA(f.alt))\n  fy=fy+22;local vc=cT;if(f.vspd or 0)>10 then vc=cS elseif(f.vspd or 0)<-10 then vc=cW end\n  local vs=(f.vspd or 0)>=0 and \"+\" or \"\";lbl(L,x1+6,fy,\"V-SPD\");val(L,x1+62,fy,fmt(\"%s%.1f m/s\",vs,f.vspd or 0),vc)\n  fy=fy+22;lbl(L,x1+6,fy,\"ATMO\");fc(L,cT);addText(L,fN,fmt(\"%.1f%%\",f.atmo or 0),x1+62,fy)\n  lbl(L,x1+150,fy,\"THR\");fc(L,cT);addText(L,fN,fmt(\"%d%%\",f.thr or 0),x1+200,fy)\n  fy=fy+20;stp(L,x1+6,fy,f.inA,\"ATMO\");stp(L,x1+75,fy,f.gear,\"GEAR\");stp(L,x1+140,fy,f.brk,\"BRK\");stp(L,x1+200,fy,f.near,\"NEAR\")\n  -- Autopilot panel\n  pnl(L,x2,y1,pw,165);hdr(L,x2+6,y1+6,\"AUTOPILOT\")\n  local ay=y1+26;local asc=a.on and cS or cD\n  lbl(L,x2+6,ay,\"STATUS\");fc(L,asc);addText(L,fH,a.on and \"ENGAGED\" or \"OFF\",x2+62,ay);ay=ay+20\n  lbl(L,x2+6,ay,\"PHASE\");fc(L,cT);addText(L,fN,a.stat or \"---\",x2+62,ay);ay=ay+18\n  lbl(L,x2+6,ay,\"TARGET\");fc(L,cT);addText(L,fN,a.tgt or \"None\",x2+62,ay);ay=ay+18\n  if a.dist and a.dist>0 then lbl(L,x2+6,ay,\"DIST\");fc(L,cT);addText(L,fN,fD(a.dist),x2+62,ay);ay=ay+18 end\n  if a.bDist and a.bDist>0 then lbl(L,x2+6,ay,\"BRAKE\");fc(L,cW);addText(L,fN,fD(a.bDist),x2+62,ay);ay=ay+18 end\n  ay=ay+4;stp(L,x2+6,ay,a.ah,\"ALT\");stp(L,x2+65,ay,a.tb,\"T+B\");stp(L,x2+130,ay,a.orb,\"ORB\");stp(L,x2+190,ay,a.re,\"RE\")\n  -- Fuel panel\n  local by=204\n  pnl(L,x1,by,pw,175);hdr(L,x1+6,by+6,\"FUEL\")\n  local bY,bW,bH,bSp=by+28,pw-80,10,38\n  local function fuelRow(yy,data,lb)\n    if not data then return end;lbl(L,x1+6,yy,lb)\n    local bc=cA;if data.pct<10 then bc=cR elseif data.pct<25 then bc=cW end\n    br(L,x1+6,yy+14,bW,bH,data.pct,bc)\n    fc(L,cT);setNextTextAlign(L,AlignH_Right,AlignV_Top);addText(L,fS,fmt(\"%d%%\",data.pct),x1+pw-8,yy+13)\n  end\n  if u.atmo then fuelRow(bY,u.atmo,fmt(\"ATMO [%d]\",u.atmo.count or 0));bY=bY+bSp end\n  if u.space then fuelRow(bY,u.space,fmt(\"SPACE [%d]\",u.space.count or 0));bY=bY+bSp end\n  if u.rocket then fuelRow(bY,u.rocket,fmt(\"RCKT [%d]\",u.rocket.count or 0)) end\n  -- Ship panel\n  pnl(L,x2,by,pw,175);hdr(L,x2+6,by+6,\"SHIP STATUS\")\n  local sy=by+28\n  if s.shld and s.shld>=0 then\n    local sc2=cA;if s.shld<25 then sc2=cR elseif s.shld<50 then sc2=cW end\n    lbl(L,x2+6,sy,\"SHIELD\");fc(L,sc2);addText(L,fL,fmt(\"%d%%\",s.shld),x2+62,sy)\n  else lbl(L,x2+6,sy,\"SHIELD\");fc(L,cD);addText(L,fN,\"N/A\",x2+62,sy) end\n  lbl(L,x2+180,sy,\"MASS\");fc(L,cT)\n  local ms=(f.mass or 0)>1000 and fmt(\"%.1f t\",(f.mass or 0)/1000) or fmt(\"%d kg\",f.mass or 0)\n  addText(L,fN,ms,x2+230,sy)\n  sy=sy+30;sc(L,cB);setNextStrokeWidth(L,1);addLine(L,x2+4,sy-6,x2+pw-4,sy-6)\n  hdr(L,x2+6,sy,\"ODOMETER\");sy=sy+20\n  lbl(L,x2+6,sy,\"DIST\");fc(L,cT);addText(L,fN,fD(s.odo),x2+50,sy)\n  lbl(L,x2+180,sy,\"TIME\");fc(L,cT);addText(L,fN,fT(s.ft),x2+220,sy)\n  fresh(L,6,ry-36)\nend\n\n-- ═════════ PAGE 2: RADAR ═════════\nlocal rsLbl={[1]=\"OPERATIONAL\",[0]=\"BROKEN\",[-1]=\"JAMMED\",[-2]=\"OBSTRUCTED\",[-3]=\"IN USE\",[-4]=\"NO RADAR\"}\nlocal rsClr={[1]=cS,[0]=cR,[-1]=cR,[-2]=cW,[-3]=cW,[-4]=cD}\nlocal function pgRadar()\n  local pvp=(s.pvp) or (r.pvp);titleBar(\"ARCHHUD RADAR\",pvp and \"PVP ZONE\" or \"SAFE ZONE\",pvp and cR or cS)\n  if not r.state and not r.list then noData(\"No radar telemetry from databank\");return end\n  -- Status bar\n  local st=r.state or -4;local stL=rsLbl[st] or \"?\";local stC=rsClr[st] or cD\n  setNextFillColor(L,0.08,0.12,0.16,0.9);addBox(L,0,32,rx,26)\n  lbl(L,8,36,\"RADAR\");fc(L,stC);addCircle(L,72,42,4);fc(L,stC);addText(L,fN,stL,82,36)\n  local cc=r.count or 0;lbl(L,260,36,\"CONTACTS\");fc(L,cc>0 and cA or cD);addText(L,fH,tostring(cc),340,36)\n  if pvp and r.list then\n    local th=0;for _,c in ipairs(r.list) do if not c.f and c.k==\"Dynamic\" then th=th+1 end end\n    if th>0 then lbl(L,390,36,\"THREATS\");fc(L,cR);addText(L,fH,tostring(th),460,36) end\n  end\n  -- Contact table\n  local tY,rH,mR=62,22,22\n  pnl(L,4,tY,rx-8,ry-tY-28)\n  local hY=tY+8\n  fc(L,cA);addText(L,fS,\"#\",10,hY);fc(L,cA);addText(L,fS,\"NAME\",36,hY);fc(L,cA);addText(L,fS,\"DISTANCE\",460,hY)\n  fc(L,cA);addText(L,fS,\"SIZE\",600,hY);fc(L,cA);addText(L,fS,\"TYPE\",680,hY);fc(L,cA);addText(L,fS,\"STATUS\",800,hY)\n  sc(L,cB);setNextStrokeWidth(L,1);addLine(L,8,hY+12,rx-8,hY+12)\n  local cts=r.list or {};local rY=hY+16;local rd=0\n  if #cts==0 then\n    fc(L,cD);setNextTextAlign(L,AlignH_Center,AlignV_Top);addText(L,fN,st==1 and \"NO CONTACTS\" or (\"RADAR \"..stL),hw,rY+30)\n  else\n    table.sort(cts,function(a2,b2) return(a2.d or 0)<(b2.d or 0) end)\n    for i,ct in ipairs(cts) do\n      if rd>=mR then break end\n      local yy=rY+rd*rH;local nc=cA\n      if ct.f then nc=cS elseif ct.k==\"Static\" then nc=cSt\n      elseif pvp then nc=ct.d<2000 and cR or cAm end\n      if rd%2==0 then setNextFillColor(L,0.12,0.16,0.22,0.4);addBox(L,6,yy-2,rx-12,rH-2) end\n      fc(L,cD);addText(L,fS,tostring(i),10,yy)\n      local nm=ct.n or \"?\";if #nm>30 then nm=nm:sub(1,28)..\"..\" end\n      fc(L,nc);addText(L,fN,nm,36,yy)\n      local dc=cT;if pvp and not ct.f and ct.k==\"Dynamic\" then dc=ct.d<2000 and cR or(ct.d<10000 and cW or dc) end\n      fc(L,dc);addText(L,fN,fD(ct.d or 0),460,yy)\n      fc(L,cD);addText(L,fS,ct.s or \"?\",600,yy);fc(L,ct.k==\"Dynamic\" and cA or cSt);addText(L,fS,ct.k or \"?\",680,yy)\n      fc(L,ct.f and cS or cD);addText(L,fS,ct.f and \"FRIENDLY\" or \"UNKNOWN\",800,yy)\n      rd=rd+1\n    end\n    if #cts>mR then fc(L,cD);setNextTextAlign(L,AlignH_Center,AlignV_Top);addText(L,fS,fmt(\"... +%d more\",#cts-mR),hw,rY+mR*rH+4) end\n  end\n  fresh(L,6,ry-36)\nend\n\n-- ═════════ PAGE 3: DAMAGE ═════════\nlocal function igClr(pct)\n  pct=max(0,min(100,pct))\n  if pct>=50 then local t2=(pct-50)/50;return{(255-195*t2)/255,1,120*t2/255,1}\n  else local t2=pct/50;return{1,(60+195*t2)/255,(60-60*t2)/255,1} end\nend\nlocal function pgDamage()\n  titleBar(\"ARCHHUD DAMAGE REPORT\")\n  if not d.pct then noData(\"Damage telemetry published every 10s while seated\");return end\n  local pct=d.pct or 0;local ic=igClr(pct)\n  fc(L,ic);setNextTextAlign(L,AlignH_Center,AlignV_Top);addText(L,fXL,fmt(\"%.1f%%\",pct),hw,40)\n  fc(L,cD);setNextTextAlign(L,AlignH_Center,AlignV_Top);addText(L,fS,\"SHIP INTEGRITY\",hw,68)\n  -- Bar\n  local bx,bY2,bW2,bH2=10,82,rx-20,14\n  br(L,bx,bY2,bW2,bH2,pct,ic);sc(L,cB);setNextStrokeWidth(L,1);addBoxRounded(L,bx,bY2,bW2,bH2,2)\n  fc(L,cD);setNextTextAlign(L,AlignH_Center,AlignV_Top);addText(L,fS,fmt(\"%d damaged | %d disabled | %d total\",d.dmg or 0,d.off or 0,d.tot or 0),hw,100)\n  -- Element list\n  local lT,lB=116,ry-28;pnl(L,4,lT,rx-8,lB-lT)\n  local list=d.list\n  if not list or #list==0 then\n    fc(L,cS);setNextTextAlign(L,AlignH_Center,AlignV_Middle);addText(L,fH,\"ALL SYSTEMS OPERATIONAL\",hw,(lT+lB)/2)\n  else\n    local hdY2=lT+8\n    fc(L,cD);addText(L,fS,\"ELEMENT\",8,hdY2);fc(L,cD);addText(L,fS,\"TYPE\",300,hdY2)\n    fc(L,cD);addText(L,fS,\"HEALTH\",520,hdY2);fc(L,cD);addText(L,fS,\"HP\",800,hdY2)\n    sc(L,cB);setNextStrokeWidth(L,1);addLine(L,6,hdY2+12,rx-6,hdY2+12)\n    local rowH2=28;local cTop=hdY2+16;local avail=lB-cTop-6;local pp=max(1,floor(avail/rowH2))\n    dmgTmr=dmgTmr+1;if dmgTmr>15 then dmgTmr=0;dmgPg=dmgPg+1 end\n    local tPages=max(1,math.ceil(#list/pp));local pg2=dmgPg%tPages\n    local sI=pg2*pp+1;local eI=min(sI+pp-1,#list);local ey=cTop\n    for i=sI,eI do\n      local el=list[i];if el then\n        local ep=el.mhp>0 and(el.hp/el.mhp*100) or 0;local dead=el.hp<=0 or el.off\n        local rc=dead and cR or(ep>=50 and cW or {1,0.51,0.12,1})\n        local nm=(el.n or \"?\"):sub(1,22);local et=(el.t or \"\"):sub(1,18)\n        fc(L,rc);addText(L,fN,nm,8,ey);fc(L,cD);addText(L,fS,et,300,ey)\n        br(L,520,ey+2,240,8,ep,rc)\n        if dead then fc(L,cR);addText(L,fS,\"DESTROYED\",800,ey)\n        else fc(L,cD);addText(L,fS,fmt(\"%d/%d\",el.hp,el.mhp),800,ey) end\n        ey=ey+rowH2\n      end\n    end\n    if tPages>1 then fc(L,cD);setNextTextAlign(L,AlignH_Right,AlignV_Top);addText(L,fS,fmt(\"PAGE %d/%d\",pg2+1,tPages),rx-10,lB-2) end\n  end\nend\n\n-- ═════════ PAGE 4: FLIGHT RECORDER ═════════\nlocal function drawChart(pY,pH,vals,n,color,lab,fmtL,fmtC,showZero)\n  local pX,pW=60,rx-120;local pX2=pX+pW;local plY,plH=pY+26,pH-32;local infoX=rx-100\n  pnl(L,4,pY,rx-8,pH);hdr(L,8,pY+6,lab)\n  if n==0 then fc(L,cD);setNextTextAlign(L,AlignH_Center,AlignV_Middle);addText(L,fS,\"NO DATA\",hw,pY+pH/2);return end\n  local vn,vx=vals[1],vals[1]\n  for i=2,n do if vals[i]<vn then vn=vals[i] end;if vals[i]>vx then vx=vals[i] end end\n  if showZero then if vn>0 then vn=0 end;if vx<0 then vx=0 end end\n  local rng=vx-vn;if rng<0.1 then local ct=(vn+vx)/2;vn=ct-1;vx=ct+1;rng=2 else vn=vn-rng*0.08;vx=vx+rng*0.08;rng=vx-vn end\n  -- Grid\n  for i=0,4 do\n    local fr=i/4;local gy=plY+plH-fr*plH;local gv=vn+fr*rng\n    sc(L,cG);setNextStrokeWidth(L,0.5);addLine(L,pX,gy,pX2,gy)\n    fc(L,cD);setNextTextAlign(L,AlignH_Right,AlignV_Middle);addText(L,fS,fmtL(gv),pX-4,gy)\n  end\n  -- Zero line\n  if showZero and vn<0 and vx>0 then\n    local zy=plY+plH-((0-vn)/rng)*plH\n    sc(L,{1,1,1,0.3});setNextStrokeWidth(L,1);addLine(L,pX,zy,pX2,zy)\n  end\n  -- Data line\n  local tS,tE=h[1][1],h[n][1];local tR=tE-tS;if tR<1 then tR=1 end\n  for i=2,n do\n    local x1f=(h[i-1][1]-tS)/tR;local y1f=(vals[i-1]-vn)/rng\n    local x2f=(h[i][1]-tS)/tR;local y2f=(vals[i]-vn)/rng\n    sc(L,color);setNextStrokeWidth(L,2)\n    addLine(L,pX+x1f*pW,plY+plH-y1f*plH,pX+x2f*pW,plY+plH-y2f*plH)\n  end\n  -- Current value dot\n  local ex=pX+pW;local ey=plY+plH-((vals[n]-vn)/rng)*plH\n  fc(L,color);addCircle(L,ex,ey,3)\n  -- Info\n  fc(L,cD);addText(L,fS,\"NOW\",infoX,pY+6)\n  fc(L,color);addText(L,fH,fmtC(vals[n]),infoX,pY+18)\nend\nlocal function pgRecorder()\n  local n=#h;titleBar(\"ARCHHUD FLIGHT RECORDER\")\n  if n>0 and ts-(h[n][1] or 0)<30 then\n    fc(ov,cR);addCircle(ov,rx-100,12,4)\n    fc(ov,cR);addText(ov,fS,\"REC\",rx-92,7)\n    fc(ov,cD);addText(ov,fS,fmt(\"%d pts\",n),rx-60,7)\n  end\n  local speeds,alts,vspeeds={},{},{}\n  for i=1,n do speeds[i]=h[i][2]*3.6;alts[i]=h[i][3];vspeeds[i]=h[i][4] end\n  local cH=floor((ry-80)/3)\n  drawChart(34,cH,speeds,n,cA,\"SPEED (km/h)\",\n    function(v) return v>10000 and fmt(\"%.1fk\",v/1000) or fmt(\"%.0f\",v) end,\n    function(v) return fmt(\"%.0f km/h\",v) end,false)\n  drawChart(38+cH,cH,alts,n,cS,\"ALTITUDE\",\n    function(v) return fA(v) end,function(v) return fA(v) end,false)\n  drawChart(42+cH*2,cH,vspeeds,n,cW,\"V-SPEED (m/s)\",\n    function(v) return fmt(\"%.1f\",v) end,\n    function(v) return fmt(\"%s%.1f\",v>=0 and \"+\" or \"\",v) end,true)\n  -- Duration\n  if n>0 then\n    local dur=ts-h[1][1]\n    local dt=dur>3600 and fmt(\"%.1fh recorded\",dur/3600) or(dur>60 and fmt(\"%dm recorded\",floor(dur/60)) or fmt(\"%ds recorded\",floor(dur)))\n    fc(L,cD);setNextTextAlign(L,AlignH_Right,AlignV_Top);addText(L,fS,dt,rx-8,ry-34)\n  end\n  fresh(L,6,ry-36)\nend\n\n-- ═════════ PAGE 5: ROUTE PLANNER ═════════\nlocal function pgRoute()\n  titleBar(\"ARCHHUD ROUTE PLANNER\")\n  if not rt.active and not rt.wps then\n    if not rt.count then noData(\"Route telemetry published every 3s while seated\");return end\n    pnl(L,10,50,rx-20,100)\n    fc(L,cD);setNextTextAlign(L,AlignH_Center,AlignV_Middle);addText(L,fH,\"NO ACTIVE ROUTE\",hw,85)\n    fc(L,{0.51,0.88,1,0.5});setNextTextAlign(L,AlignH_Center,AlignV_Middle);addText(L,fS,\"Use ALT+SHIFT+8 to add waypoints\",hw,108)\n    if rt.saved and rt.savedCount and rt.savedCount>0 then\n      fc(L,cS);setNextTextAlign(L,AlignH_Center,AlignV_Middle);addText(L,fS,fmt(\"Saved route: %d waypoints\",rt.savedCount),hw,125)\n    end\n    return\n  end\n  local wps=rt.wps or {};local wpc=rt.count or #wps;local prog=rt.progress or 0;local spd=rt.spd or 0\n  -- Progress bar\n  pnl(L,4,34,rx-8,60)\n  hdr(L,8,38,\"ROUTE\");fc(L,cA);addText(L,fH,fmt(\"%.1f%%\",prog),60,38)\n  local pbX,pbY3,pbW3,pbH3=8,56,rx-16,12\n  br(L,pbX,pbY3,pbW3,pbH3,prog,cA);sc(L,cB);setNextStrokeWidth(L,1);addBoxRounded(L,pbX,pbY3,pbW3,pbH3,2)\n  -- Stats row\n  local sY2=74\n  lbl(L,8,sY2,\"TOTAL\");fc(L,cA);addText(L,fS,fD(rt.totalDist),50,sY2)\n  lbl(L,180,sY2,\"LEFT\");fc(L,cW);addText(L,fS,fD(rt.remainDist),210,sY2)\n  lbl(L,360,sY2,\"ETA\");fc(L,cS);addText(L,fS,fT(rt.remainEta),390,sY2)\n  lbl(L,520,sY2,\"SPD\");fc(L,cA);addText(L,fS,fS(spd),550,sY2)\n  lbl(L,680,sY2,\"WP\");fc(L,cA);addText(L,fS,tostring(wpc),700,sY2)\n  local apOn=a.on;lbl(L,780,sY2,\"AP\");fc(L,apOn and cS or cD);addText(L,fS,apOn and \"ON\" or \"OFF\",800,sY2)\n  -- Waypoint list\n  local ltop=98;pnl(L,4,ltop,rx-8,ry-ltop-28)\n  local hdY3=ltop+8\n  fc(L,cA);addText(L,fS,\"#\",12,hdY3);fc(L,cA);addText(L,fS,\"WAYPOINT\",40,hdY3);fc(L,cA);addText(L,fS,\"PLANET\",430,hdY3)\n  fc(L,cA);addText(L,fS,\"LEG\",570,hdY3);fc(L,cA);addText(L,fS,\"DIST\",680,hdY3);fc(L,cA);addText(L,fS,\"ETA\",820,hdY3)\n  sc(L,cB);setNextStrokeWidth(L,1);addLine(L,8,hdY3+12,rx-8,hdY3+12)\n  local rowH3=30;local rSY=hdY3+16;local maxR2=floor((ry-28-rSY-6)/rowH3)\n  for i=1,min(wpc,maxR2) do\n    local wp=wps[i];if not wp then break end\n    local yy=rSY+(i-1)*rowH3;local cur=wp.cur\n    local nc,tc=cur and cCu or{0.51,0.88,1,0.5},cur and cT or cD\n    if cur then setNextFillColor(L,1,0.86,0.20,0.06);addBox(L,6,yy-4,rx-12,rowH3-2) end\n    -- Node\n    if cur then fc(L,cCu);addCircle(L,20,yy+4,7);setNextFillColor(L,0.05,0.06,0.09,1);addCircle(L,20,yy+4,4)\n      fc(L,cCu);setNextTextAlign(L,AlignH_Center,AlignV_Middle);addText(L,fS,tostring(i),20,yy+4)\n    else fc(L,nc);addCircle(L,20,yy+4,5);fc(L,nc);setNextTextAlign(L,AlignH_Center,AlignV_Middle);addText(L,fS,tostring(i),20,yy+4) end\n    if i<wpc and i<maxR2 then sc(L,{0.51,0.88,1,0.15});setNextStrokeWidth(L,1);addLine(L,20,yy+12,20,yy+rowH3-4) end\n    local nm=(wp.n or \"?\"):sub(1,28);fc(L,nc);addText(L,fN,nm,40,yy)\n    if cur then fc(L,cCu);addText(L,fS,\"CURRENT TARGET\",40,yy+14) end\n    fc(L,tc);addText(L,fS,wp.p or \"\",430,yy)\n    fc(L,tc);addText(L,fS,fD(wp.leg),570,yy)\n    fc(L,cur and cCu or tc);addText(L,fS,fD(wp.d),680,yy)\n    local eta=\"---\";if spd>1 and wp.d and wp.d>0 then eta=fT(wp.d/spd) end\n    fc(L,cur and cS or tc);addText(L,fS,eta,820,yy)\n  end\n  if wpc>maxR2 then fc(L,cD);setNextTextAlign(L,AlignH_Center,AlignV_Top);addText(L,fS,fmt(\"... +%d more\",wpc-maxR2),hw,rSY+maxR2*rowH3+4) end\nend\n\n-- Page dispatch\nlocal pages={pgTelemetry,pgRadar,pgDamage,pgRecorder,pgRoute}\nif pages[page] then pages[page]() end\n\n-- Navigation bar\nlocal ny=ry-18\nsetNextFillColor(bg,0.06,0.08,0.10,0.9);addBox(bg,0,ry-22,rx,22)\nsetNextFillColor(ov,cA[1],cA[2],cA[3],0.35);addText(ov,fN,\"<\",8,ny-4)\nsetNextFillColor(ov,cA[1],cA[2],cA[3],0.35);setNextTextAlign(ov,AlignH_Right,AlignV_Top);addText(ov,fN,\">\",rx-8,ny-4)\nfc(ov,cD);setNextTextAlign(ov,AlignH_Center,AlignV_Top);addText(ov,fS,fmt(\"%s  %d/%d\",pgN[page] or \"?\",page,PAGES),hw,ny-2)\nlocal dotX=hw-(PAGES*7)\nfor i=1,PAGES do\n  if i==page then fc(ov,cA) else setNextFillColor(ov,0.24,0.27,0.31,0.6) end\n  addCircle(ov,dotX+i*14,ny+10,2)\nend\n\nsetOutput(tostring(page))\nrequestAnimationFrame(15)\n]=]\n\n-- ═══════════════════════════════════════════\n-- TIMER CALLBACK\n-- ═══════════════════════════════════════════\nfunction onBoardTick(timerId)\n    if timerId == \"refresh\" then\n        -- Flight recorder\n        recorderTicks = recorderTicks + 1\n        if recorderTicks >= RECORDER_TICKS then\n            recordSnapshot()\n            recorderTicks = 0\n        end\n        -- Alerts\n        checkDamageAlerts()\n        checkRadarAlerts()\n        checkRecorderAlerts()\n        -- Push page-specific data to each screen (1024 char input limit)\n        if screen and db then\n            local pg = tonumber(screen.getScriptOutput()) or 1\n            screen.setScriptInput(collectDataForPage(pg))\n        end\n        if screen2 and db then\n            local pg = tonumber(screen2.getScriptOutput()) or 1\n            screen2.setScriptInput(collectDataForPage(pg))\n        end\n    end\nend\n\n-- ═══════════════════════════════════════════\n-- STOP HANDLER\n-- ═══════════════════════════════════════════\nfunction onBoardStop()\n    if screen then screen.setRenderScript(\"\") end\n    if screen2 then screen2.setRenderScript(\"\") end\nend\n\n-- ═══════════════════════════════════════════\n-- AUTO-INITIALIZATION\n-- ═══════════════════════════════════════════\nif not db then\n    system.print(\"ArchHUD Display: No databank. Rename databank slot to 'db'.\")\n    return\nend\nif not screen then\n    system.print(\"ArchHUD Display: No screen. Rename screen slot to 'screen'.\")\n    return\nend\nloadHistory()\n-- Set render scripts\nscreen.setRenderScript(RENDER_SCRIPT)\nif screen2 then screen2.setRenderScript(RENDER_SCRIPT) end\n-- Start data timer\nunit.setTimer(\"refresh\", TICK_INTERVAL)\n-- Push initial data (default to page 1)\nlocal initData = collectDataForPage(1)\nscreen.setScriptInput(initData)\nif screen2 then screen2.setScriptInput(initData) end\nlocal mode = screen2 and \"2 screens\" or \"1 screen\"\nsystem.print(stringf(\"ArchHUD Combined Display started. 5 pages, %s. Click screen to navigate.\", mode))\n",
      "filter": {
        "args": [],
        "signature": "onStart()",
        "slotKey": "-1"
      },
      "key": "0"
    },
    {
      "code": "onBoardTick(timerId)",
      "filter": {
        "args": [
          {
            "value": "refresh"
          }
        ],
        "signature": "onTimer(timerId)",
        "slotKey": "-1"
      },
      "key": "1"
    },
    {
      "code": "onBoardStop()",
      "filter": {
        "args": [],
        "signature": "onStop()",
        "slotKey": "-1"
      },
      "key": "2"
    }
  ],
  "methods": [],
  "events": []
}