{
  "slots": {
    "0": {
      "name": "db",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "1": {
      "name": "screen",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "-1": {
      "name": "unit",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "-2": {
      "name": "system",
      "type": {
        "events": [],
        "methods": []
      }
    },
    "-3": {
      "name": "library",
      "type": {
        "events": [],
        "methods": []
      }
    }
  },
  "handlers": [
    {
      "code": "-- ArchHUD Radar Tactical Display - Programming Board Script\n-- Reads radar telemetry data from a shared databank and renders a tactical contact display on a linked screen.\n--\n-- ═══════════════════════════════════════════════════════\n-- SETUP INSTRUCTIONS\n-- ═══════════════════════════════════════════════════════\n-- 1. Place a programming board, a screen, and link BOTH to the same databank\n--    used by your ArchHUD seat (the dbHud slot).\n-- 2. Right-click the programming board > Advanced > Edit Lua.\n-- 3. In the slot list (left side), rename the databank slot to \"db\"\n--    and the screen slot to \"screen\".\n-- 4. Select the filter: unit > onStart\n--    Paste this ENTIRE script into the code editor.\n-- 5. Add a NEW filter: unit > onTimer(timerId)\n--    Paste this single line:     onBoardTick(timerId)\n-- 6. Add a NEW filter: unit > onStop\n--    Paste this single line:     if screen then screen.setHTML(\"\") end\n-- 7. Apply changes and activate the programming board.\n-- ═══════════════════════════════════════════════════════\n--\n-- Databank keys read:\n--   T_radar  = radar contact list and state (published by ArchHUD every 2s)\n--   T_flight = flight telemetry (for timestamp/freshness check)\n--   T_ship   = ship info (for PVP zone status)\n--\n-- T_radar structure:\n--   { count=N, state=1, pvp=true/false, list={ {n=\"Name\", d=meters, s=\"M\", k=\"Dynamic\", f=false}, ... } }\n--\n-- Radar state codes:\n--   1=Operational, 0=Broken, -1=Jammed, -2=Obstructed, -3=In Use, -4=No Radar\n--\n-- Slots (rename in the Lua editor slot list):\n--   db     = databank (same one linked to your seat/ECU as dbHud)\n--   screen = ScreenUnit\n\nlocal db = db       ---@type databank\nlocal screen = screen ---@type ScreenUnit\nlocal unit = unit   ---@type ProgrammingBoard\nlocal system = system\n\n-- json fallback for emulators (du-lua.dev) where the library slot\n-- doesn't inject the json global automatically.\nif not json then\n    json = {}\n    -- Minimal JSON decoder\n    function json.decode(s)\n        if not s or s == \"\" then return nil end\n        local i = 1\n        local V\n        local function w() while i <= #s and s:byte(i) <= 32 do i = i + 1 end end\n        local function S()\n            i = i + 1; local b = {}\n            while true do\n                local c = s:sub(i,i)\n                if c == '\"' then break\n                elseif c == '\\\\' then i=i+1; c=s:sub(i,i); if c=='n' then b[#b+1]='\\n' elseif c=='t' then b[#b+1]='\\t' else b[#b+1]=c end\n                else b[#b+1] = c end\n                i = i + 1\n            end\n            i = i + 1; return table.concat(b)\n        end\n        V = function()\n            w(); local c = s:sub(i,i)\n            if c == '\"' then return S()\n            elseif c == '{' then\n                i=i+1; w(); local t = {}\n                if s:sub(i,i) ~= '}' then\n                    local k = S(); w(); i=i+1; t[k] = V()\n                    while true do w(); if s:sub(i,i) ~= ',' then break end; i=i+1; k=S(); w(); i=i+1; t[k]=V() end\n                end; w(); i=i+1; return t\n            elseif c == '[' then\n                i=i+1; w(); local t = {}\n                if s:sub(i,i) ~= ']' then\n                    t[1]=V(); local n=1\n                    while true do w(); if s:sub(i,i) ~= ',' then break end; i=i+1; n=n+1; t[n]=V() end\n                end; w(); i=i+1; return t\n            elseif c == 't' then i=i+4; return true\n            elseif c == 'f' then i=i+5; return false\n            elseif c == 'n' then i=i+4; return nil\n            else local j2=i; if c=='-' then i=i+1 end; while i<=#s and s:sub(i,i):match('[%deE%.%+%-]') do i=i+1 end; return tonumber(s:sub(j2,i-1))\n            end\n        end\n        local ok, r = pcall(V); return ok and r or nil\n    end\n    -- Minimal JSON encoder\n    function json.encode(val)\n        local buf = {}\n        local function enc(v)\n            local tp = type(v)\n            if v == nil then buf[#buf+1] = \"null\"\n            elseif tp == \"boolean\" then buf[#buf+1] = v and \"true\" or \"false\"\n            elseif tp == \"number\" then\n                if v ~= v then buf[#buf+1] = \"null\"\n                elseif v == 1/0 then buf[#buf+1] = \"1e999\"\n                elseif v == -1/0 then buf[#buf+1] = \"-1e999\"\n                else buf[#buf+1] = string.format(\"%.14g\", v) end\n            elseif tp == \"string\" then\n                buf[#buf+1] = '\"'; buf[#buf+1] = v:gsub('[\\\\\"\\n\\t\\r]', {['\\\\']='\\\\\\\\',  ['\"']='\\\\\"', ['\\n']='\\\\n', ['\\t']='\\\\t', ['\\r']='\\\\r'}); buf[#buf+1] = '\"'\n            elseif tp == \"table\" then\n                -- Detect array vs object: sequential integer keys from 1..#v\n                local n = #v\n                local isArr = n > 0\n                if isArr then for k in pairs(v) do if type(k) ~= \"number\" or k < 1 or k > n or k ~= math.floor(k) then isArr = false; break end end end\n                if isArr then\n                    buf[#buf+1] = '['\n                    for i = 1, n do if i > 1 then buf[#buf+1] = ',' end; enc(v[i]) end\n                    buf[#buf+1] = ']'\n                else\n                    buf[#buf+1] = '{'\n                    local first = true\n                    for k2, v2 in pairs(v) do\n                        if type(k2) == \"string\" then\n                            if not first then buf[#buf+1] = ',' end; first = false\n                            enc(k2); buf[#buf+1] = ':'; enc(v2)\n                        end\n                    end\n                    buf[#buf+1] = '}'\n                end\n            end\n        end\n        enc(val)\n        return table.concat(buf)\n    end\nend\nlocal jdecode = json.decode\nlocal jencode = json.encode\nlocal mfloor = math.floor\nlocal stringf = string.format\nlocal tblSort = table.sort\nlocal tblConcat = table.concat\n\n-- Alert state: track previous contacts to detect new arrivals\nlocal prevContactIds = {}   -- set of previously seen contact names+distance keys\nlocal prevThreatClose = 0   -- count of hostiles within 2km last tick\n\n-- ════════════════════════════════════════════\n-- Helpers\n-- ════════════════════════════════════════════\n\n-- Safe JSON decode with fallback\nlocal function safeDecode(key)\n    if not db.hasKey(key) then return nil end\n    local ok, result = pcall(jdecode, db.getStringValue(key))\n    if ok then return result end\n    return nil\nend\n\n-- Format distance for display\nlocal function fmtDist(meters)\n    if meters > 200000 then\n        return stringf(\"%.2f su\", meters / 200000)\n    elseif meters > 1000 then\n        return stringf(\"%.1f km\", meters / 1000)\n    else\n        return stringf(\"%.0f m\", meters)\n    end\nend\n\n-- Color helpers\nlocal function rgb(r, g, b) return stringf(\"rgb(%d,%d,%d)\", r, g, b) end\nlocal function rgba(r, g, b, a) return stringf(\"rgba(%d,%d,%d,%.2f)\", r, g, b, a) end\n\n-- Escape special XML characters in contact names\nlocal function escXml(s)\n    if not s then return \"?\" end\n    return s:gsub(\"&\", \"&amp;\"):gsub(\"<\", \"&lt;\"):gsub(\">\", \"&gt;\"):gsub('\"', \"&quot;\")\nend\n\n-- ════════════════════════════════════════════\n-- Theme colors (matches Telemetry Dashboard)\n-- ════════════════════════════════════════════\nlocal accentColor  = rgb(130, 224, 255)\nlocal dimColor     = rgb(90, 155, 180)\nlocal warnColor    = rgb(255, 165, 0)\nlocal dangerColor  = rgb(255, 60, 60)\nlocal safeColor    = rgb(60, 255, 120)\nlocal pvpColor     = rgb(255, 60, 60)\nlocal bgColor      = rgb(12, 16, 22)\nlocal panelColor   = rgba(20, 30, 40, 0.85)\nlocal borderColor  = rgba(130, 224, 255, 0.3)\nlocal staticColor  = rgb(100, 110, 125)\nlocal amberColor   = rgb(255, 190, 50)\n\n-- ════════════════════════════════════════════\n-- Radar state labels\n-- ════════════════════════════════════════════\nlocal radarStateLabels = {\n    [1]  = \"OPERATIONAL\",\n    [0]  = \"BROKEN\",\n    [-1] = \"JAMMED\",\n    [-2] = \"OBSTRUCTED\",\n    [-3] = \"IN USE\",\n    [-4] = \"NO RADAR\",\n}\n\nlocal radarStateColors = {\n    [1]  = safeColor,\n    [0]  = dangerColor,\n    [-1] = dangerColor,\n    [-2] = warnColor,\n    [-3] = warnColor,\n    [-4] = dimColor,\n}\n\n-- ════════════════════════════════════════════\n-- Contact color logic\n-- ════════════════════════════════════════════\nlocal function contactColor(contact, isPvp)\n    -- Friendly contacts are always green\n    if contact.f then\n        return safeColor\n    end\n    -- Static constructs are dim\n    if contact.k == \"Static\" then\n        return staticColor\n    end\n    -- Dynamic constructs in PVP zone\n    if isPvp then\n        if contact.d < 2000 then\n            return dangerColor   -- Close proximity = red alert\n        else\n            return amberColor    -- PVP zone dynamic = amber warning\n        end\n    end\n    -- Dynamic constructs in safe zone\n    return accentColor\nend\n\n-- ════════════════════════════════════════════\n-- Friendly status label\n-- ════════════════════════════════════════════\nlocal function friendlyLabel(contact)\n    if contact.f then return \"FRIENDLY\" end\n    return \"UNKNOWN\"\nend\n\nlocal function friendlyColor(contact)\n    if contact.f then return safeColor end\n    return dimColor\nend\n\n-- ════════════════════════════════════════════\n-- Main render function\n-- ════════════════════════════════════════════\nlocal function renderDashboard()\n    local radar  = safeDecode(\"T_radar\")\n    local flight = safeDecode(\"T_flight\")\n    local ship   = safeDecode(\"T_ship\")\n\n    -- Screen dimensions\n    local sw, sh = 1920, 1080\n    local maxRows = 22  -- Max contact rows that fit on screen\n\n    local svg = {}\n    svg[#svg+1] = stringf([[<svg viewBox=\"0 0 %d %d\" xmlns=\"http://www.w3.org/2000/svg\">]], sw, sh)\n\n    -- Background\n    svg[#svg+1] = stringf([[<rect width=\"%d\" height=\"%d\" fill=\"%s\"/>]], sw, sh, bgColor)\n\n    -- ═══════════════════════════════════════\n    -- TITLE BAR\n    -- ═══════════════════════════════════════\n    local isPvp = (ship and ship.pvp) or (radar and radar.pvp)\n    local titleColor = isPvp and pvpColor or accentColor\n    local zoneLabel = isPvp and \"PVP ZONE\" or \"SAFE ZONE\"\n    local zoneColor = isPvp and pvpColor or safeColor\n\n    svg[#svg+1] = stringf([[<rect x=\"0\" y=\"0\" width=\"%d\" height=\"50\" fill=\"%s\"/>]], sw, rgba(20, 30, 40, 0.95))\n    svg[#svg+1] = stringf([[<text x=\"20\" y=\"34\" fill=\"%s\" font-size=\"22\" font-family=\"monospace\" font-weight=\"bold\">ARCHHUD RADAR</text>]], titleColor)\n    svg[#svg+1] = stringf([[<text x=\"%d\" y=\"34\" fill=\"%s\" font-size=\"18\" font-family=\"monospace\" text-anchor=\"end\">%s</text>]], sw - 20, zoneColor, zoneLabel)\n\n    -- ═══════════════════════════════════════\n    -- NO DATA FALLBACK\n    -- ═══════════════════════════════════════\n    if not radar then\n        svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"28\" font-family=\"monospace\" text-anchor=\"middle\">AWAITING DATA</text>]],\n            sw/2, sh/2 - 30, warnColor)\n        svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" text-anchor=\"middle\">No radar telemetry received from databank</text>]],\n            sw/2, sh/2 + 10, dimColor)\n        svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" text-anchor=\"middle\">Link this board to the same databank as your ArchHUD seat and ensure radar is equipped</text>]],\n            sw/2, sh/2 + 40, dimColor)\n        svg[#svg+1] = \"</svg>\"\n        return tblConcat(svg)\n    end\n\n    -- ═══════════════════════════════════════\n    -- STATUS BAR (below title)\n    -- ═══════════════════════════════════════\n    local statusY = 55\n    svg[#svg+1] = stringf([[<rect x=\"0\" y=\"%d\" width=\"%d\" height=\"55\" fill=\"%s\"/>]], statusY, sw, panelColor)\n\n    -- Radar status\n    local rState = radar.state or -4\n    local stateLabel = radarStateLabels[rState] or \"UNKNOWN\"\n    local stateColor = radarStateColors[rState] or dimColor\n\n    svg[#svg+1] = stringf([[<text x=\"40\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">RADAR STATUS</text>]], statusY + 24, dimColor)\n    svg[#svg+1] = stringf([[<circle cx=\"200\" cy=\"%d\" r=\"6\" fill=\"%s\"/>]], statusY + 20, stateColor)\n    svg[#svg+1] = stringf([[<text x=\"214\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\" font-weight=\"bold\">%s</text>]], statusY + 25, stateColor, stateLabel)\n\n    -- Contact count\n    local contactCount = radar.count or 0\n    local countColor = contactCount > 0 and accentColor or dimColor\n    svg[#svg+1] = stringf([[<text x=\"500\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">CONTACTS</text>]], statusY + 24, dimColor)\n    svg[#svg+1] = stringf([[<text x=\"620\" y=\"%d\" fill=\"%s\" font-size=\"22\" font-family=\"monospace\" font-weight=\"bold\">%d</text>]], statusY + 26, countColor, contactCount)\n\n    -- Threat summary (count of non-friendly dynamic contacts in PVP)\n    if isPvp and radar.list then\n        local threats = 0\n        for _, c in ipairs(radar.list) do\n            if not c.f and c.k == \"Dynamic\" then threats = threats + 1 end\n        end\n        if threats > 0 then\n            svg[#svg+1] = stringf([[<text x=\"720\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">THREATS</text>]], statusY + 24, dimColor)\n            svg[#svg+1] = stringf([[<text x=\"830\" y=\"%d\" fill=\"%s\" font-size=\"22\" font-family=\"monospace\" font-weight=\"bold\">%d</text>]], statusY + 26, dangerColor, threats)\n        end\n    end\n\n    -- ═══════════════════════════════════════\n    -- CONTACT TABLE\n    -- ═══════════════════════════════════════\n    local tableY = 120\n    local rowH = 36\n    local headerY = tableY + 8\n\n    -- Table panel background\n    svg[#svg+1] = stringf([[<rect x=\"20\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" stroke=\"%s\" rx=\"6\"/>]],\n        tableY, sw - 40, sh - tableY - 50, panelColor, borderColor)\n\n    -- Column positions\n    local colNum  = 50\n    local colName = 110\n    local colDist = 900\n    local colSize = 1200\n    local colType = 1350\n    local colFriend = 1600\n\n    -- Header row\n    local hdrY = headerY + 22\n    svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" font-weight=\"bold\">#</text>]], colNum, hdrY, accentColor)\n    svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" font-weight=\"bold\">NAME</text>]], colName, hdrY, accentColor)\n    svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" font-weight=\"bold\">DISTANCE</text>]], colDist, hdrY, accentColor)\n    svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" font-weight=\"bold\">SIZE</text>]], colSize, hdrY, accentColor)\n    svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" font-weight=\"bold\">TYPE</text>]], colType, hdrY, accentColor)\n    svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\" font-weight=\"bold\">STATUS</text>]], colFriend, hdrY, accentColor)\n\n    -- Header separator line\n    svg[#svg+1] = stringf([[<line x1=\"40\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke=\"%s\" stroke-width=\"1\"/>]],\n        hdrY + 8, sw - 40, hdrY + 8, borderColor)\n\n    -- Sort contacts by distance (closest first)\n    local contacts = radar.list or {}\n    tblSort(contacts, function(a, b) return (a.d or 0) < (b.d or 0) end)\n\n    -- Render contact rows\n    local rowStartY = hdrY + 14\n    local rendered = 0\n\n    if #contacts == 0 and rState == 1 then\n        -- Operational but no contacts\n        svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"18\" font-family=\"monospace\" text-anchor=\"middle\">NO CONTACTS DETECTED</text>]],\n            sw/2, rowStartY + 60, dimColor)\n    elseif rState ~= 1 then\n        -- Radar not operational\n        svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"18\" font-family=\"monospace\" text-anchor=\"middle\">RADAR %s</text>]],\n            sw/2, rowStartY + 60, stateColor, stateLabel)\n    else\n        for i, contact in ipairs(contacts) do\n            if rendered >= maxRows then break end\n\n            local ry = rowStartY + (rendered * rowH)\n            local nameColor = contactColor(contact, isPvp)\n\n            -- Alternating row background (subtle)\n            if rendered % 2 == 0 then\n                svg[#svg+1] = stringf([[<rect x=\"30\" y=\"%d\" width=\"%d\" height=\"%d\" fill=\"%s\" rx=\"2\"/>]],\n                    ry - 2, sw - 60, rowH - 2, rgba(30, 40, 55, 0.4))\n            end\n\n            -- Row number\n            svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"14\" font-family=\"monospace\">%d</text>]],\n                colNum, ry + 20, dimColor, i)\n\n            -- Contact name (truncate if too long)\n            local name = escXml(contact.n or \"Unknown\")\n            if #name > 50 then name = name:sub(1, 47) .. \"...\" end\n            svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\">%s</text>]],\n                colName, ry + 21, nameColor, name)\n\n            -- Distance\n            local distStr = fmtDist(contact.d or 0)\n            local distColor = \"white\"\n            if isPvp and not contact.f and contact.k == \"Dynamic\" then\n                if contact.d < 2000 then distColor = dangerColor\n                elseif contact.d < 10000 then distColor = warnColor end\n            end\n            svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"16\" font-family=\"monospace\">%s</text>]],\n                colDist, ry + 21, distColor, distStr)\n\n            -- Size\n            svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\">%s</text>]],\n                colSize, ry + 21, dimColor, contact.s or \"?\")\n\n            -- Type (Dynamic/Static)\n            local typeColor = contact.k == \"Dynamic\" and accentColor or staticColor\n            svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\">%s</text>]],\n                colType, ry + 21, typeColor, contact.k or \"?\")\n\n            -- Friendly status\n            svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"15\" font-family=\"monospace\">%s</text>]],\n                colFriend, ry + 21, friendlyColor(contact), friendlyLabel(contact))\n\n            rendered = rendered + 1\n        end\n\n        -- Show overflow indicator\n        if #contacts > maxRows then\n            local overflowY = rowStartY + (maxRows * rowH) + 16\n            svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\" text-anchor=\"middle\">... and %d more contact(s) beyond display limit</text>]],\n                sw/2, overflowY, dimColor, #contacts - maxRows)\n        end\n    end\n\n    -- ═══════════════════════════════════════\n    -- BOTTOM BAR: Data freshness\n    -- ═══════════════════════════════════════\n    local bottomY = sh - 35\n    svg[#svg+1] = stringf([[<line x1=\"20\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke=\"%s\" stroke-width=\"1\"/>]],\n        bottomY - 5, sw - 20, bottomY - 5, borderColor)\n\n    if flight and flight.time then\n        local age = system.getArkTime() - flight.time\n        local freshColor = age < 4 and safeColor or (age < 10 and warnColor or dangerColor)\n        local freshText = age < 4 and \"LIVE\" or stringf(\"%.0fs AGO\", age)\n        svg[#svg+1] = stringf([[<circle cx=\"40\" cy=\"%d\" r=\"5\" fill=\"%s\"/>]], bottomY + 8, freshColor)\n        svg[#svg+1] = stringf([[<text x=\"52\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\">DATA: %s</text>]], bottomY + 12, freshColor, freshText)\n    else\n        svg[#svg+1] = stringf([[<circle cx=\"40\" cy=\"%d\" r=\"5\" fill=\"%s\"/>]], bottomY + 8, dimColor)\n        svg[#svg+1] = stringf([[<text x=\"52\" y=\"%d\" fill=\"%s\" font-size=\"13\" font-family=\"monospace\">DATA: NO TIMESTAMP</text>]], bottomY + 12, dimColor)\n    end\n\n    -- Version / label on bottom right\n    svg[#svg+1] = stringf([[<text x=\"%d\" y=\"%d\" fill=\"%s\" font-size=\"12\" font-family=\"monospace\" text-anchor=\"end\">ARCHHUD RADAR TACTICAL DISPLAY</text>]],\n        sw - 30, bottomY + 12, rgba(130, 224, 255, 0.3))\n\n    svg[#svg+1] = \"</svg>\"\n    return tblConcat(svg)\nend\n\n--- Check radar data and write alert to databank if new threats detected\nlocal function checkAlerts()\n    local radar = safeDecode(\"T_radar\")\n    if not radar or not radar.list then return end\n\n    local isPvp = radar.pvp\n    local contacts = radar.list\n    local alertMsg = nil\n    local threatClose = 0\n\n    -- Build current contact set and count close threats\n    local currentIds = {}\n    for _, c in ipairs(contacts) do\n        local key = (c.n or \"?\") .. \"_\" .. (c.s or \"?\")\n        currentIds[key] = true\n\n        -- Count non-friendly dynamic contacts within 2km in PVP\n        if isPvp and not c.f and c.k == \"Dynamic\" and c.d < 2000 then\n            threatClose = threatClose + 1\n        end\n    end\n\n    -- Alert: new hostile within 2km\n    if threatClose > prevThreatClose and isPvp then\n        local newThreats = threatClose - prevThreatClose\n        alertMsg = stringf(\"THREAT: %d hostile(s) within 2 km!\", newThreats)\n    end\n\n    -- Alert: new dynamic contact appeared (not seen last tick)\n    if not alertMsg then\n        for _, c in ipairs(contacts) do\n            if c.k == \"Dynamic\" and not c.f then\n                local key = (c.n or \"?\") .. \"_\" .. (c.s or \"?\")\n                if not prevContactIds[key] then\n                    local zoneTxt = isPvp and \" in PVP zone\" or \"\"\n                    alertMsg = stringf(\"Radar: New contact '%s' at %s%s\", c.n or \"Unknown\", fmtDist(c.d or 0), zoneTxt)\n                    break\n                end\n            end\n        end\n    end\n\n    prevContactIds = currentIds\n    prevThreatClose = threatClose\n\n    if alertMsg then\n        db.setStringValue(\"A_radar\", jencode({\n            msg = alertMsg,\n            t = system.getArkTime()\n        }))\n    end\nend\n\n-- ════════════════════════════════════════════\n-- Timer callback (global so unit > onTimer can call it)\n-- In unit > onTimer, paste:  onBoardTick(timerId)\n-- ════════════════════════════════════════════\nfunction onBoardTick(timerId)\n    if timerId == \"refresh\" then\n        if screen and db then\n            checkAlerts()\n            screen.setHTML(renderDashboard())\n        end\n    end\nend\n\n-- ════════════════════════════════════════════\n-- Auto-initialization (runs on unit > onStart)\n-- ════════════════════════════════════════════\nif not db then\n    system.print(\"ArchHUD Radar: No databank linked. Rename the databank slot to 'db' and restart.\")\n    return\nend\nif not screen then\n    system.print(\"ArchHUD Radar: No screen linked. Rename the screen slot to 'screen' and restart.\")\n    return\nend\nunit.setTimer(\"refresh\", 2)\nsystem.print(\"ArchHUD Radar Tactical Display started.\")\nscreen.setHTML(renderDashboard())\n",
      "filter": {
        "args": [],
        "signature": "onStart()",
        "slotKey": "-1"
      },
      "key": "0"
    },
    {
      "code": "onBoardTick(timerId)",
      "filter": {
        "args": [
          {
            "value": "refresh"
          }
        ],
        "signature": "onTimer(timerId)",
        "slotKey": "-1"
      },
      "key": "1"
    },
    {
      "code": "if screen then screen.setHTML(\"\") end",
      "filter": {
        "args": [],
        "signature": "onStop()",
        "slotKey": "-1"
      },
      "key": "2"
    }
  ],
  "methods": [],
  "events": []
}